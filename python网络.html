<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-09-27 Sun 17:24 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>python网络</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="chimez" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">python网络</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org63dd3f1">1. xmlrpc</a>
<ul>
<li><a href="#orgaa0bee9">1.1. 服务端</a></li>
<li><a href="#org7a4c683">1.2. 客户端</a></li>
</ul>
</li>
<li><a href="#orgc326ad2">2. Requests 与 Requests-HTML</a>
<ul>
<li><a href="#org7967cef">2.1. 安装与基本配置</a></li>
<li><a href="#org0acafea">2.2. 基本使用</a></li>
<li><a href="#org1b858fe">2.3. 使用 socks5 代理</a></li>
<li><a href="#org4fe81bb">2.4. 下载文件</a></li>
</ul>
</li>
<li><a href="#org39909fc">3. BeautifulSoup4</a>
<ul>
<li><a href="#orgf2c4d47">3.1. 安装</a></li>
<li><a href="#orgbdeee6d">3.2. 标签的使用</a></li>
<li><a href="#orgc1de9ff">3.3. 标签的遍历</a></li>
<li><a href="#org9b76b29">3.4. 标签的寻找</a></li>
<li><a href="#org72d93e3">3.5. css选择器</a></li>
</ul>
</li>
<li><a href="#org9b16def">4. flask</a>
<ul>
<li><a href="#orgdd1bb41">4.1. Flask 框架学习记录</a>
<ul>
<li><a href="#org8f301d3">4.1.1. 基本使用</a></li>
<li><a href="#orgc074e68">4.1.2. 指南</a></li>
<li><a href="#orgd5972bb">4.1.3. 插件</a></li>
</ul>
</li>
<li><a href="#orge5fb3c3">4.2. flask-restful 快速创建 RESTful api 服务器</a>
<ul>
<li><a href="#orgf25d11c">4.2.1. 基本使用</a></li>
</ul>
</li>
<li><a href="#orgce8121b">4.3. Flask-SQLAlchemy ORM 对象关系映射</a>
<ul>
<li><a href="#orgc9bd8d7">4.3.1. 基本使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5a3bbcb">5. scrapy</a>
<ul>
<li><a href="#org572c3af">5.1. 基本使用</a>
<ul>
<li><a href="#orgf8519f0">5.1.1. 创建项目</a></li>
<li><a href="#org9085cb2">5.1.2. 获取下一页以及构造item</a></li>
<li><a href="#org37661d7">5.1.3. 利用 <code>ImagesPipeline</code> 保存图片的方法</a></li>
<li><a href="#orgf3fd2c6">5.1.4. 交互式试探解析网页</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>





<div id="outline-container-org63dd3f1" class="outline-2">
<h2 id="org63dd3f1"><span class="section-number-2">1</span> xmlrpc</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgaa0bee9" class="outline-3">
<h3 id="orgaa0bee9"><span class="section-number-3">1.1</span> 服务端</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> xmlrpc.server <span style="color: #859900; font-weight: bold;">import</span> SimpleXMLRPCServer

<span style="color: #268bd2;">QUIT_SERVER</span> = <span style="color: #268bd2; font-weight: bold;">False</span>


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">is_even</span><span style="color: #2aa198;">(</span>n<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> n % 2 == 0


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">kill</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">global</span> QUIT_SERVER
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">QUIT_SERVER</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> 1


<span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">main</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">server</span> = SimpleXMLRPCServer<span style="color: #2aa198;">(</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">"localhost"</span>, 8000<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"Listening on port 8000..."</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   server.register_function<span style="color: #2aa198;">(</span>is_even, <span style="color: #2aa198;">"is_even"</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   server.register_function<span style="color: #2aa198;">(</span>kill, <span style="color: #2aa198;">"kill"</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">global</span> QUIT_SERVER
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">while</span> <span style="color: #859900; font-weight: bold;">not</span> QUIT_SERVER:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   server.handle_request<span style="color: #2aa198;">()</span>

<span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   main<span style="color: #2aa198;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7a4c683" class="outline-3">
<h3 id="org7a4c683"><span class="section-number-3">1.2</span> 客户端</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">import</span> xmlrpc.client

<span style="color: #859900; font-weight: bold;">with</span> xmlrpc.client.ServerProxy<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"http://localhost:8000/"</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">as</span> proxy:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">"3 is even: %s"</span> % <span style="color: #657b83; font-weight: bold;">str</span><span style="color: #b58900;">(</span>proxy.is_even<span style="color: #268bd2;">(</span>3<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>proxy.kill<span style="color: #b58900;">()</span><span style="color: #2aa198;">)</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc326ad2" class="outline-2">
<h2 id="orgc326ad2"><span class="section-number-2">2</span> Requests 与 Requests-HTML</h2>
<div class="outline-text-2" id="text-2">
<p>
官网 <a href="https://requests-html.kennethreitz.org/">https://requests-html.kennethreitz.org/</a>
</p>
</div>
<div id="outline-container-org7967cef" class="outline-3">
<h3 id="org7967cef"><span class="section-number-3">2.1</span> 安装与基本配置</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-bash">pipenv install requests-html
</pre>
</div>
</div>
</div>
<div id="outline-container-org0acafea" class="outline-3">
<h3 id="org0acafea"><span class="section-number-3">2.2</span> 基本使用</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> requests_html <span style="color: #859900; font-weight: bold;">import</span> HTMLSession
<span style="color: #268bd2;">session</span> = HTMLSession<span style="color: #2aa198;">()</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#25235;&#21462;&#32593;&#39029;</span>
<span style="color: #268bd2;">r</span> = session.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'https://python.org/'</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">javascript &#28210;&#26579;</span>
r.html.render<span style="color: #2aa198;">()</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">css&#26041;&#24335;&#25628;&#32034;</span>
<span style="color: #268bd2;">about</span> = r.html.find<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'#about'</span>, first=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>

<span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">xpath&#26041;&#24335;&#25628;&#32034;</span>
<span style="color: #268bd2;">a_xpath</span> = r.html.xpath<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'a'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org1b858fe" class="outline-3">
<h3 id="org1b858fe"><span class="section-number-3">2.3</span> 使用 socks5 代理</h3>
<div class="outline-text-3" id="text-2-3">
<p>
首先要安装 socks 版本的 requests
</p>
<div class="org-src-container">
<pre class="src src-bash">pip install -U requests<span style="color: #2aa198;">[</span>socks<span style="color: #2aa198;">]</span>
</pre>
</div>
<p>
使用
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">import</span> requests

<span style="color: #268bd2;">resp</span> = requests.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'http://go.to'</span>, 
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   proxies=<span style="color: #657b83; font-weight: bold;">dict</span><span style="color: #b58900;">(</span>http=<span style="color: #2aa198;">'socks5://user:pass@host:port'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>https=<span style="color: #2aa198;">'socks5://user:pass@host:port'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4fe81bb" class="outline-3">
<h3 id="org4fe81bb"><span class="section-number-3">2.4</span> 下载文件</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">import</span> requests
<span style="color: #859900; font-weight: bold;">import</span> shutil

<span style="color: #268bd2;">r</span> = requests.get<span style="color: #2aa198;">(</span>settings.STATICMAP_URL.<span style="color: #657b83; font-weight: bold;">format</span><span style="color: #b58900;">(</span>**data<span style="color: #b58900;">)</span>, stream=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="color: #859900; font-weight: bold;">if</span> r.status_code == 200:
<span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">with</span> <span style="color: #657b83; font-weight: bold;">open</span><span style="color: #2aa198;">(</span>path, <span style="color: #2aa198;">'wb'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">as</span> f:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">r.raw.decode_content</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   shutil.copyfileobj<span style="color: #2aa198;">(</span>r.raw, f<span style="color: #2aa198;">)</span>    
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org39909fc" class="outline-2">
<h2 id="org39909fc"><span class="section-number-2">3</span> BeautifulSoup4</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgf2c4d47" class="outline-3">
<h3 id="orgf2c4d47"><span class="section-number-3">3.1</span> 安装</h3>
<div class="outline-text-3" id="text-3-1">
<p>
beauiful soup4: python3-bs4
第三解析器： lxml html5lib
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #859900; font-weight: bold;">from</span> bs4 <span style="color: #859900; font-weight: bold;">import</span> BeautifulSoup           <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#23548;&#20837;</span>
<span style="color: #268bd2;">soup</span>= BeautifulSoup<span style="color: #2aa198;">(</span>html_file, <span style="color: #2aa198;">'lxml'</span><span style="color: #2aa198;">)</span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#21021;&#22987;&#21270;</span>
soupprettify<span style="color: #2aa198;">()</span>                         <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#26684;&#24335;&#21270;&#25171;&#21360;</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbdeee6d" class="outline-3">
<h3 id="orgbdeee6d"><span class="section-number-3">3.2</span> 标签的使用</h3>
<div class="outline-text-3" id="text-3-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>up.title, soup.head, soup.a, soup.p</code></td>
<td class="org-left">选择tag</td>
</tr>

<tr>
<td class="org-left"><code>up.title.name, soup.title.attrs</code></td>
<td class="org-left">名字和属性</td>
</tr>

<tr>
<td class="org-left"><code>up.p['class'], soup.p.get('class')</code></td>
<td class="org-left">选择属性的方法</td>
</tr>

<tr>
<td class="org-left"><code>up.p.string</code></td>
<td class="org-left">获得内容</td>
</tr>

<tr>
<td class="org-left"><code>4.element.Comment</code></td>
<td class="org-left">注释对象</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc1de9ff" class="outline-3">
<h3 id="orgc1de9ff"><span class="section-number-3">3.3</span> 标签的遍历</h3>
<div class="outline-text-3" id="text-3-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>up.head.contents</code></td>
<td class="org-left">获得直接子节点的列表</td>
</tr>

<tr>
<td class="org-left"><code>up.head.children</code></td>
<td class="org-left">获得可遍历的子节点对象</td>
</tr>

<tr>
<td class="org-left"><code>up.descendants</code></td>
<td class="org-left">获得全部下级节点</td>
</tr>

<tr>
<td class="org-left"><code>up.parent, soup.parents</code></td>
<td class="org-left">获得父节点</td>
</tr>

<tr>
<td class="org-left"><code>up.p.next_sibling, soup.p.previous_sibling</code></td>
<td class="org-left">获得同级节点</td>
</tr>

<tr>
<td class="org-left"><code>up.p.next_element, soup.p.previous_element</code></td>
<td class="org-left">获得下一个/上一个节点</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org9b76b29" class="outline-3">
<h3 id="org9b76b29"><span class="section-number-3">3.4</span> 标签的寻找</h3>
<div class="outline-text-3" id="text-3-4">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>up.find_all(name, attrs, recursive, text, **kwargs)</code></td>
<td class="org-left">返回list</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all('a'), soup.find_all(['a', 'b'])</code></td>
<td class="org-left">查找名字</td>
</tr>

<tr>
<td class="org-left"><code>portre;soup.find_all(re.compile("^b"))</code></td>
<td class="org-left">查找正则表达式</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all(func)</code></td>
<td class="org-left">查找一个一元函数</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all(id='aaa')</code></td>
<td class="org-left">查找属性，id，class等</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all(true, limit=2)</code></td>
<td class="org-left">限制层级数</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all("title", recursive=False)</code></td>
<td class="org-left">只查找直接节点</td>
</tr>

<tr>
<td class="org-left"><code>up.find(name, attrs, recursive, text, **kwargs)</code></td>
<td class="org-left">返回对象而不是列表</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org72d93e3" class="outline-3">
<h3 id="org72d93e3"><span class="section-number-3">3.5</span> css选择器</h3>
<div class="outline-text-3" id="text-3-5">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>soup.select('title')</code></td>
<td class="org-left">选择名字</td>
</tr>

<tr>
<td class="org-left"><code>soup.select('.classname')</code></td>
<td class="org-left">选择类名</td>
</tr>

<tr>
<td class="org-left"><code>soup.select('#id')</code></td>
<td class="org-left">选择id</td>
</tr>

<tr>
<td class="org-left"><code>soup.select('a[class="classname"]')</code></td>
<td class="org-left">组合选择标签和属性</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-org9b16def" class="outline-2">
<h2 id="org9b16def"><span class="section-number-2">4</span> flask</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgdd1bb41" class="outline-3">
<h3 id="orgdd1bb41"><span class="section-number-3">4.1</span> Flask 框架学习记录</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org8f301d3" class="outline-4">
<h4 id="org8f301d3"><span class="section-number-4">4.1.1</span> 基本使用</h4>
<div class="outline-text-4" id="text-4-1-1">
</div>
<ol class="org-ol">
<li><a id="org92d446e"></a>基本项目<br />
<div class="outline-text-5" id="text-4-1-1-1">
<p>
一个基本的文件内容如下:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">hello.py</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">hello_world</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'Hello, World!'</span><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
</pre>
</div>
<p>
启动方式为:
</p>
<div class="org-src-container">
<pre class="src src-bash">      <span style="color: #657b83; font-weight: bold;">export</span> <span style="color: #268bd2;">FLASK_APP</span>=hello.py
      flask run
</pre>
</div>
<p>
开启Debug 模式,需要额外增加环境变量: <code>export FLASK_ENV=development</code>
</p>
</div>
</li>
<li><a id="org85bb574"></a>路由规则<br />
<ol class="org-ol">
<li><a id="orge4c114f"></a>路由路径的表示<br />
<div class="outline-text-6" id="text-4-1-1-2-1">
<p>
路由使用装饰器表示,函数返回值即为网页显示内容:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#26080;&#21305;&#37197;&#21442;&#25968;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'Index Page'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#40664;&#35748;&#21305;&#37197;&#20026;&#23383;&#31526;&#20018;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;username&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">show_user_profile</span><span style="color: #2aa198;">(</span>username<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">show the user profile for that user</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'User %s'</span> % username

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#21487;&#20197;&#25351;&#23450;&#21305;&#37197;&#31867;&#22411;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/post/&lt;int:post_id&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">show_post</span><span style="color: #2aa198;">(</span>post_id<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">show the post with the given id, the id is an integer</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'Post %d'</span> % post_id
</pre>
</div>
<p>
可以匹配的类型为:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>string</code></td>
<td class="org-left">字符串,这是默认值</td>
</tr>

<tr>
<td class="org-left"><code>int</code></td>
<td class="org-left">整数</td>
</tr>

<tr>
<td class="org-left"><code>float</code></td>
<td class="org-left">浮点数</td>
</tr>

<tr>
<td class="org-left"><code>path</code></td>
<td class="org-left">路径,与字符串类似,但是可以包括斜线</td>
</tr>

<tr>
<td class="org-left"><code>uuid</code></td>
<td class="org-left">uuid字符串</td>
</tr>
</tbody>
</table>
</div>
</li>
<li><a id="orga00fe46"></a>HTTP方法的表示<br />
<div class="outline-text-6" id="text-4-1-1-2-2">
<p>
可以在路由中指定可用的HTTP方法,并在函数中根据不同的方法执行不同的动作.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> request

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/login'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> do_the_login<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">else</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> show_the_login_form<span style="color: #2aa198;">()</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org50898f7"></a>使用 <code>url_for</code> 生成url<br />
<ol class="org-ol">
<li><a id="orgf5e092d"></a>函数对应的url地址<br />
<div class="outline-text-6" id="text-4-1-1-3-1">
<p>
虽然可以到处硬编码url,但是不够灵活,因此应该使用 <code>url_for</code> 来生成需要的url
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask, url_for

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'index'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/login'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'login'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/user/&lt;username&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">profile</span><span style="color: #2aa198;">(</span>username<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'{}\'s profile'</span>.<span style="color: #657b83; font-weight: bold;">format</span><span style="color: #2aa198;">(</span>username<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> app.test_request_context<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'login'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'login'</span>, <span style="color: #657b83; font-weight: bold;">next</span>=<span style="color: #2aa198;">'/'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'profile'</span>, username=<span style="color: #2aa198;">'John Doe'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/login</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/login?next=/</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/user/John%20Doe</span>
</pre>
</div>
</div>
</li>
<li><a id="orgbce68d3"></a>静态资源的地址<br />
<div class="outline-text-6" id="text-4-1-1-3-2">
<p>
使用 <code>filename</code> 参数即可产生静态资源地址
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  url_for<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'static'</span>, filename=<span style="color: #2aa198;">'style.css'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">/static/style.css</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org1ce9a3a"></a>渲染模板<br />
<div class="outline-text-5" id="text-4-1-1-4">
<p>
默认的模板引擎为 <code>Jinja2</code>, 使用函数 <code>render_template</code>, 即可从模板生成页面:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> render_template

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/hello/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/hello/&lt;name&gt;'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">hello</span><span style="color: #2aa198;">(</span>name=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'hello.html'</span>, name=name<span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
所有的模板需要在 <code>templates</code> 文件夹中
一个样例模板为:
</p>
<div class="org-src-container">
<pre class="src src-html">      &lt;<span style="color: #859900; font-weight: bold;">!doctype</span> html&gt;
      &lt;<span style="color: #268bd2;">title</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Hello from Flask</span>&lt;/<span style="color: #268bd2;">title</span>&gt;
      {% if name %}
      &lt;<span style="color: #268bd2;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Hello {{ name }}!</span>&lt;/<span style="color: #268bd2;">h1</span>&gt;
      {% else %}
      &lt;<span style="color: #268bd2;">h1</span>&gt;<span style="font-weight: bold; text-decoration: underline;">Hello, World!</span>&lt;/<span style="color: #268bd2;">h1</span>&gt;
      {% endif %}
</pre>
</div>
</div>
</li>
<li><a id="org54509ec"></a>处理请求 <code>request</code><br />
<ol class="org-ol">
<li><a id="org4f0665f"></a>判断请求类型<br />
<div class="outline-text-6" id="text-4-1-1-5-1">
<p>
使用方法 <code>request.methods == 'POST'</code> 等
</p>
</div>
</li>
<li><a id="org24312e3"></a>获取 <code>POST</code> 与 <code>PUT</code> 中的数据<br />
<div class="outline-text-6" id="text-4-1-1-5-2">
<p>
使用 <code>request.form["key"]</code> 等
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> request
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/login'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'POST'</span>, <span style="color: #2aa198;">'GET'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #268bd2; font-weight: bold;">None</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> valid_login<span style="color: #2aa198;">(</span>request.form<span style="color: #b58900;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #b58900;">]</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> request.form<span style="color: #b58900;">[</span><span style="color: #2aa198;">'password'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> log_the_user_in<span style="color: #2aa198;">(</span>request.form<span style="color: #b58900;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">else</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #2aa198;">'Invalid username/password'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">the code below is executed if the request method</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">was GET or the credentials were invalid</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'login.html'</span>, error=error<span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="orgab2736c"></a>获取url中的参数<br />
<div class="outline-text-6" id="text-4-1-1-5-3">
<p>
对于形如 <code>?key=value</code> 的url, 使用 <code>args</code> 属性获取内容.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">searchword</span> = request.args.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'key'</span>, <span style="color: #2aa198;">''</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org7c3e35f"></a>处理文件上传<br />
<div class="outline-text-6" id="text-4-1-1-5-4">
<p>
使用 <code>request.files</code> 方法, 以及相应的 <code>.save</code> 方法即可
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> request

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/upload'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">upload_file</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">f</span> = request.files<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'the_file'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  f.save<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/var/www/uploads/uploaded_file.txt'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  ...
</pre>
</div>
<p>
为了避免一些攻击,可以使用安全文件名检查
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> request
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> werkzeug.utils <span style="color: #859900; font-weight: bold;">import</span> secure_filename

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/upload'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">upload_file</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">f</span> = request.files<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'the_file'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  f.save<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/var/www/uploads/'</span> + secure_filename<span style="color: #b58900;">(</span>f.filename<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  ...
</pre>
</div>
</div>
</li>
<li><a id="org3fbb0f5"></a>处理 Cookies<br />
<ol class="org-ol">
<li><a id="org3ecce46"></a>读取 Cookies<br />
<div class="outline-text-7" id="text-4-1-1-5-5-1">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> request

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">username</span> = request.cookies.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'username'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">use cookies.get(key) instead of cookies[key] to not get a</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">KeyError if the cookie is missing.</span>
</pre>
</div>
</div>
</li>
<li><a id="orgcf76f26"></a>设置 Cookies<br />
<div class="outline-text-7" id="text-4-1-1-5-5-2">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> make_response

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #268bd2;">resp</span> = make_response<span style="color: #2aa198;">(</span>render_template<span style="color: #b58900;">(</span>...<span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   resp.set_cookie<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'username'</span>, <span style="color: #2aa198;">'the username'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="color: #859900; font-weight: bold;">return</span> resp
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org5fe8e45"></a>重定向与错误<br />
<div class="outline-text-6" id="text-4-1-1-5-6">
<p>
重定向使用 <code>redirect(url)</code> 函数.
产生错误响应使用 <code>abort(401)</code> 函数.
捕获并处理错误使用 <code>app.errorhandler(401)</code> 装饰器, 如果处理了 404 错误, 就相当于定制了 404 页面.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> abort, redirect, url_for, render_template

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'login'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/login'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  abort<span style="color: #2aa198;">(</span>401<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  this_is_never_executed<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">page_not_found</span><span style="color: #2aa198;">(</span>error<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'page_not_found.html'</span><span style="color: #2aa198;">)</span>, 404
</pre>
</div>
</div>
</li>
<li><a id="orga5409c7"></a>发送响应<br />
<div class="outline-text-6" id="text-4-1-1-5-7">
<p>
在每个函数的返回值处, 返回的就是响应.
这个响应是一个三元组 <code>(响应,状态,响应头)</code>, 但这些里只有响应内容是必须要返回的, 默认的响应状态为 <code>200</code>, 而响应头会自动生成.
定制响应可以在返回值处加上状态,或使用 <code>make_response()</code> 创建一个响应,并返回它.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#22312;&#20989;&#25968;&#36820;&#22238;&#20540;&#22788;&#36827;&#34892;&#21709;&#24212;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">not_found</span><span style="color: #2aa198;">(</span>error<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'error.html'</span><span style="color: #2aa198;">)</span>, 404
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#20351;&#29992; make_response &#23450;&#21046;&#21709;&#24212;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.errorhandler</span><span style="color: #2aa198;">(</span>404<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">not_found</span><span style="color: #2aa198;">(</span>error<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">resp</span> = make_response<span style="color: #2aa198;">(</span>render_template<span style="color: #b58900;">(</span><span style="color: #2aa198;">'error.html'</span><span style="color: #b58900;">)</span>, 404<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">resp.headers</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'X-Something'</span><span style="color: #2aa198;">]</span> = <span style="color: #2aa198;">'A value'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> resp
</pre>
</div>
</div>
</li>
<li><a id="org455c501"></a>会话 Session<br />
<div class="outline-text-6" id="text-4-1-1-5-8">
<p>
会话是用来从一个请求向下一个请求维持数据的,需要在 Cookies 里秘密维护一个值.
因此得自己设一个密钥值,用来存在 Cookies 里, <code>app.secret_key</code>.
在登录时把它放进 Cookies 里, <code>session["..."]=request.form["..."]=</code>.
再请求时就检查一下, <code>session["..."]</code>.
退出时要清理它, <code>session.pop</code>.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask, session, redirect, url_for, escape, request

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Set the secret key to some random bytes. Keep this really secret!</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app.secret_key</span> = b<span style="color: #2aa198;">'_5#y2L"F4Q8z\n\xec]/'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">index</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">'username'</span> <span style="color: #859900; font-weight: bold;">in</span> session:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'Logged in as %s'</span> % escape<span style="color: #2aa198;">(</span>session<span style="color: #b58900;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'You are not logged in'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/login'</span>, methods=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #2aa198;">]</span> = request.form<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'''</span>
<span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">  &lt;form method="post"&gt;</span>
<span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">  &lt;p&gt;&lt;input type=text name=username&gt;</span>
<span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">  &lt;p&gt;&lt;input type=submit value=Login&gt;</span>
<span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">  &lt;/form&gt;</span>
<span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">   </span><span style="color: #2aa198; background-color: #eee8d5;"> </span><span style="color: #2aa198;">  '''</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/logout'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">logout</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">remove the username from the session if it's there</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  session.pop<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'username'</span>, <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org48173e9"></a>刷新消息<br />
<div class="outline-text-6" id="text-4-1-1-5-9">
<p>
为了给用户一些反馈,需要时不时地刷新下消息,用 <code>flash</code> 方法即可.
</p>
</div>
</li>
<li><a id="org86b2150"></a>日志<br />
<div class="outline-text-6" id="text-4-1-1-5-10">
<p>
可以简单地向标准日志中写一些信息:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.logger.debug<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'A value for debugging'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.logger.warning<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'A warning occurred (%d apples)'</span>, 42<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.logger.error<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'An error occurred'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org2f4d0f3"></a>hook WSGI 中间件<br /></li>
<li><a id="org4ef462f"></a>使用 flask 插件<br /></li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgc074e68" class="outline-4">
<h4 id="orgc074e68"><span class="section-number-4">4.1.2</span> 指南</h4>
<div class="outline-text-4" id="text-4-1-2">
</div>
<ol class="org-ol">
<li><a id="org5c122a8"></a>应用配置<br />
<ol class="org-ol">
<li><a id="orgb10eb85"></a>应用工厂函数<br />
<div class="outline-text-6" id="text-4-1-2-1-1">
<p>
虽然可以创建一个全局的APP,但更常用的方式是使用应用工厂函数.
在项目文件夹中创建 <code>__init__.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> os

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">create_app</span><span style="color: #2aa198;">(</span>test_config=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">create and configure the app</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span>, instance_relative_config=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.config.from_mapping<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  SECRET_KEY=<span style="color: #2aa198;">'dev'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  DATABASE=os.path.join<span style="color: #b58900;">(</span>app.instance_path, <span style="color: #2aa198;">'flaskr.sqlite'</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> test_config <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">load the instance config, if it exists, when not testing</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.config.from_pyfile<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'config.py'</span>, silent=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">else</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">load the test config if passed in</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.config.from_mapping<span style="color: #2aa198;">(</span>test_config<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">ensure the instance folder exists</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">try</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  os.makedirs<span style="color: #2aa198;">(</span>app.instance_path<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">except</span> <span style="color: #b58900;">OSError</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">pass</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">a simple page that says hello</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@app.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/hello'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">hello</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'Hello, World!'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> app
</pre>
</div>
</div>
</li>
<li><a id="orgb16d302"></a>运行 APP<br />
<div class="outline-text-6" id="text-4-1-2-1-2">
<div class="org-src-container">
<pre class="src src-bash">       <span style="color: #657b83; font-weight: bold;">export</span> <span style="color: #268bd2;">FLASK_APP</span>=flaskr
       <span style="color: #657b83; font-weight: bold;">export</span> <span style="color: #268bd2;">FLASK_ENV</span>=development
       flask run
</pre>
</div>
</div>
</li>
<li><a id="org91ea815"></a>说明<br />
<div class="outline-text-6" id="text-4-1-2-1-3">
<ol class="org-ol">
<li><code>app = Flask(__name__, instance_relative_config=True)</code> 创建一个实例
<ol class="org-ol">
<li><code>__name__</code> 是当前项目的名称, 也就是 flask 运行是要指定的名称</li>
<li><code>instance_relative_config=True</code> 表示配置文件在实例文件夹里, 这个文件夹要在包文件的外部, 为了分离代码和数据</li>
</ol></li>
<li><code>app.config.from_mapping()</code> 设置 APP 的默认配置
<ol class="org-ol">
<li><code>SECRET_KEY</code> 在开发时设为 <code>dev</code>, 在上线是要设为一个随机值来保证安全</li>
<li><code>DATABASE</code> 是 sqlite 的位置, 在 <code>app.instance_path</code> 文件夹里</li>
</ol></li>
<li><code>app.config.from_pyfile()</code> 会重载 <code>config.py</code> 文件为了方便设置 <code>SECRET_KEY</code> 等</li>
<li>flask 不会自动创建实例文件夹, 所以用 <code>os.makedirs()</code> 来保证文件夹存在比较好</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="org721ba18"></a>数据库<br />
<ol class="org-ol">
<li><a id="org50675c0"></a>连接到数据库<br />
<div class="outline-text-6" id="text-4-1-2-2-1">
<p>
创建一个 <code>db.py</code> 文件
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> sqlite3

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> click
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> current_app, g
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask.cli <span style="color: #859900; font-weight: bold;">import</span> with_appcontext


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get_db</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">'db'</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #859900; font-weight: bold;">in</span> g:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">g.db</span> = sqlite3.connect<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  current_app.config<span style="color: #b58900;">[</span><span style="color: #2aa198;">'DATABASE'</span><span style="color: #b58900;">]</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  detect_types=sqlite3.PARSE_DECLTYPES
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">g.db.row_factory</span> = sqlite3.Row

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> g.db


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">close_db</span><span style="color: #2aa198;">(</span>e=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">db</span> = g.pop<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'db'</span>, <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> db <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.close<span style="color: #2aa198;">()</span>
</pre>
</div>
<ol class="org-ol">
<li><code>g</code> 是每个实例都不同的对象, 用来储存数据</li>
<li><code>current_app</code> 是指向处理请求的实例的对象</li>
<li><code>sqlite3.connect()</code> 建立了数据库连接</li>
<li><code>sqlite3.Row</code> 可以返回裸数据, dict 类型</li>
</ol>
</div>
</li>
<li><a id="org649c4ba"></a>建表<br />
<div class="outline-text-6" id="text-4-1-2-2-2">
<p>
新建一个 <code>schema.sql</code> 文件, 里面写 SQL 语句
</p>
<div class="org-src-container">
<pre class="src src-sql">       <span style="color: #859900; font-weight: bold;">DROP</span> <span style="color: #859900; font-weight: bold;">TABLE</span> <span style="color: #268bd2;">IF</span> <span style="color: #859900; font-weight: bold;">EXISTS</span> <span style="color: #657b83; font-weight: bold;">user</span>;
       <span style="color: #859900; font-weight: bold;">DROP</span> <span style="color: #859900; font-weight: bold;">TABLE</span> <span style="color: #268bd2;">IF</span> <span style="color: #859900; font-weight: bold;">EXISTS</span> post;

       <span style="color: #859900; font-weight: bold;">CREATE</span> <span style="color: #859900; font-weight: bold;">TABLE</span> <span style="color: #657b83; font-weight: bold;">user</span> <span style="color: #2aa198;">(</span>
       id <span style="color: #b58900;">INTEGER</span> <span style="color: #859900; font-weight: bold;">PRIMARY</span> <span style="color: #859900; font-weight: bold;">KEY</span> AUTOINCREMENT,
       username TEXT <span style="color: #859900; font-weight: bold;">UNIQUE</span> <span style="color: #859900; font-weight: bold;">NOT</span> <span style="color: #859900; font-weight: bold;">NULL</span>,
       password TEXT <span style="color: #859900; font-weight: bold;">NOT</span> <span style="color: #859900; font-weight: bold;">NULL</span>
       <span style="color: #2aa198;">)</span>;

       <span style="color: #859900; font-weight: bold;">CREATE</span> <span style="color: #859900; font-weight: bold;">TABLE</span> <span style="color: #268bd2;">post</span> <span style="color: #2aa198;">(</span>
       id <span style="color: #b58900;">INTEGER</span> <span style="color: #859900; font-weight: bold;">PRIMARY</span> <span style="color: #859900; font-weight: bold;">KEY</span> AUTOINCREMENT,
       author_id <span style="color: #b58900;">INTEGER</span> <span style="color: #859900; font-weight: bold;">NOT</span> <span style="color: #859900; font-weight: bold;">NULL</span>,
       created <span style="color: #b58900;">TIMESTAMP</span> <span style="color: #859900; font-weight: bold;">NOT</span> <span style="color: #859900; font-weight: bold;">NULL</span> <span style="color: #859900; font-weight: bold;">DEFAULT</span> <span style="color: #657b83; font-weight: bold;">CURRENT_TIMESTAMP</span>,
       title TEXT <span style="color: #859900; font-weight: bold;">NOT</span> <span style="color: #859900; font-weight: bold;">NULL</span>,
       body TEXT <span style="color: #859900; font-weight: bold;">NOT</span> <span style="color: #859900; font-weight: bold;">NULL</span>,
       <span style="color: #859900; font-weight: bold;">FOREIGN</span> <span style="color: #859900; font-weight: bold;">KEY</span> <span style="color: #b58900;">(</span>author_id<span style="color: #b58900;">)</span> <span style="color: #859900; font-weight: bold;">REFERENCES</span> <span style="color: #657b83; font-weight: bold;">user</span> <span style="color: #b58900;">(</span>id<span style="color: #b58900;">)</span>
       <span style="color: #2aa198;">)</span>;
</pre>
</div>
<p>
并在 <code>db.py</code> 里加上
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">init_db</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">db</span> = get_db<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> current_app.open_resource<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'schema.sql'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">as</span> f:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.executescript<span style="color: #2aa198;">(</span>f.read<span style="color: #b58900;">()</span>.decode<span style="color: #b58900;">(</span><span style="color: #2aa198;">'utf8'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@click.command</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'init-db'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@with_appcontext</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">init_db_command</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">"""Clear the existing data and create new tables."""</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  init_db<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  click.echo<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'Initialized the database.'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
<ol class="org-ol">
<li><code>open_resource()</code> 会打开在资源文件夹里的文件</li>
<li><code>click.command()</code> 会新建一个命令行可用的命令</li>
</ol>
</div>
</li>
<li><a id="orgfefccc1"></a>注册 <code>db.py</code> 到应用<br />
<div class="outline-text-6" id="text-4-1-2-2-3">
<p>
在 <code>db.py</code> 里
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">init_app</span><span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.teardown_appcontext<span style="color: #2aa198;">(</span>close_db<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.cli.add_command<span style="color: #2aa198;">(</span>init_db_command<span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
在 <code>__init__.py</code> 里
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">create_app</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app</span> = ...
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">existing code omitted</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> . <span style="color: #859900; font-weight: bold;">import</span> db
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.init_app<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> app
</pre>
</div>
<ol class="org-ol">
<li><code>app.teardown_appcontext()</code> 会让 flask 在返回响应后调用这个函数</li>
<li><code>app.cli.add_command()</code> 会在命令行中新增命令</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="orga1e2aac"></a>蓝图和视图<br />
<div class="outline-text-5" id="text-4-1-2-3">
<p>
蓝图是用来组织视图和相关代码的, 之后把蓝图注册到应用中
</p>
</div>
<ol class="org-ol">
<li><a id="org3fe415f"></a>创建蓝图<br />
<div class="outline-text-6" id="text-4-1-2-3-1">
<p>
创建一个验证身份的蓝图 <code>auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> functools

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> <span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  Blueprint, flash, g, redirect, render_template, request, session, url_for
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> werkzeug.security <span style="color: #859900; font-weight: bold;">import</span> check_password_hash, generate_password_hash

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flaskr.db <span style="color: #859900; font-weight: bold;">import</span> get_db

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">bp</span> = Blueprint<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'auth'</span>, <span style="color: #657b83; font-weight: bold;">__name__</span>, url_prefix=<span style="color: #2aa198;">'/auth'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
并注册到应用中 <code>__init__.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">create_app</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app</span> = ...
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">existing code omitted</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> . <span style="color: #859900; font-weight: bold;">import</span> auth
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  app.register_blueprint<span style="color: #2aa198;">(</span>auth.bp<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> app
</pre>
</div>
<ol class="org-ol">
<li>使用 <code>Blueprint</code> 创建蓝图</li>
<li>使用 <code>app.register_blueprint</code> 注册蓝图</li>
</ol>
</div>
</li>
<li><a id="org83b0a99"></a>第一个视图: 注册<br />
<div class="outline-text-6" id="text-4-1-2-3-2">
<p>
在 <code>auth.py</code> 文件中加入
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@bp.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/register'</span>, methods=<span style="color: #b58900;">(</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">register</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">username</span> = request.form<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">password</span> = request.form<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'password'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">db</span> = get_db<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #268bd2; font-weight: bold;">None</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900; font-weight: bold;">not</span> username:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #2aa198;">'Username is required.'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">elif</span> <span style="color: #859900; font-weight: bold;">not</span> password:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #2aa198;">'Password is required.'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">elif</span> db.execute<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'SELECT id FROM user WHERE username = ?'</span>, <span style="color: #b58900;">(</span>username,<span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>.fetchone<span style="color: #2aa198;">()</span> <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #2aa198;">'User {} is already registered.'</span>.<span style="color: #657b83; font-weight: bold;">format</span><span style="color: #2aa198;">(</span>username<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> error <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.execute<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'INSERT INTO user (username, password) VALUES (?, ?)'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">(</span>username, generate_password_hash<span style="color: #268bd2;">(</span>password<span style="color: #268bd2;">)</span><span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.commit<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'auth.login'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  flash<span style="color: #2aa198;">(</span>error<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'auth/register.html'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
<ol class="org-ol">
<li><code>@bp.route</code> 用来注册路由到蓝图的路径</li>
<li><code>request.form</code> 是储存请求内容的字典</li>
<li><code>db.execute</code> 可以执行 SQL 语句, 用 <code>?</code> 表示输入占位, 会自动进行检查以防止一些注入攻击</li>
<li><code>generate_password_hash()</code> 可以生成密码的 hash 值, 不应该在数据库里写入密码</li>
<li><code>db.commit()</code> 向数据库中保存数据</li>
<li><code>fetchone()</code> 和 <code>fetchall()</code> 用来返回数据库的结果</li>
<li><code>redirect()</code> 会返回重定向网址</li>
<li><code>url_for</code> 用来生成和用户名相关的网址</li>
</ol>
</div>
</li>
<li><a id="org87b44a2"></a>登录页面<br />
<div class="outline-text-6" id="text-4-1-2-3-3">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@bp.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/login'</span>, methods=<span style="color: #b58900;">(</span><span style="color: #2aa198;">'GET'</span>, <span style="color: #2aa198;">'POST'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> request.method == <span style="color: #2aa198;">'POST'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">username</span> = request.form<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">password</span> = request.form<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'password'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">db</span> = get_db<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #268bd2; font-weight: bold;">None</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">user</span> = db.execute<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'SELECT * FROM user WHERE username = ?'</span>, <span style="color: #b58900;">(</span>username,<span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>.fetchone<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> user <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #2aa198;">'Incorrect username.'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">elif</span> <span style="color: #859900; font-weight: bold;">not</span> check_password_hash<span style="color: #2aa198;">(</span>user<span style="color: #b58900;">[</span><span style="color: #2aa198;">'password'</span><span style="color: #b58900;">]</span>, password<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">error</span> = <span style="color: #2aa198;">'Incorrect password.'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> error <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  session.clear<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">session</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'user_id'</span><span style="color: #2aa198;">]</span> = user<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'id'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  flash<span style="color: #2aa198;">(</span>error<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> render_template<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'auth/login.html'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
<ol class="org-ol">
<li><code>check_password_hash()</code> 会检查密码和数据库里的 hash 是否匹配</li>
<li><code>session</code> 会将登录信息写入到 cookies 里发给浏览器</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@bp.before_app_request</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">load_logged_in_user</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">user_id</span> = session.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'user_id'</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> user_id <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">g.user</span> = <span style="color: #268bd2; font-weight: bold;">None</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">else</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">g.user</span> = get_db<span style="color: #2aa198;">()</span>.execute<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'SELECT * FROM user WHERE id = ?'</span>, <span style="color: #b58900;">(</span>user_id,<span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>.fetchone<span style="color: #2aa198;">()</span>
</pre>
</div>
<ol class="org-ol">
<li><code>bp.before_app_request()</code> 会注册一个在运行视图函数之前就执行的函数, 用来检查 session 是否已登录</li>
</ol>
</div>
</li>
<li><a id="org1ad248c"></a>登出<br />
<div class="outline-text-6" id="text-4-1-2-3-4">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@bp.route</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/logout'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">logout</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  session.clear<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'index'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org7932eaf"></a>在其它视图中检查登录情况<br />
<div class="outline-text-6" id="text-4-1-2-3-5">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login_required</span><span style="color: #2aa198;">(</span>view<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@functools.wraps</span><span style="color: #2aa198;">(</span>view<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">wrapped_view</span><span style="color: #2aa198;">(</span>**kwargs<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> g.user <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> redirect<span style="color: #2aa198;">(</span>url_for<span style="color: #b58900;">(</span><span style="color: #2aa198;">'auth.login'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> view<span style="color: #2aa198;">(</span>**kwargs<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> wrapped_view
</pre>
</div>
<p>
这个装饰器可以在其它视图中检查是否登录, 未登录就重定向到登录页面
</p>
</div>
</li>
<li><a id="org298ac5e"></a><code>url_for</code><br />
<div class="outline-text-6" id="text-4-1-2-3-6">
<p>
为了检查蓝图中的路由, 使用 <code>'auth.login'</code> 点号来表示关系,而不是斜线
</p>
</div>
</li>
</ol>
</li>
<li><a id="org8659b89"></a>模板<br />
<div class="outline-text-5" id="text-4-1-2-4">
<div class="org-src-container">
<pre class="src src-web">      &lt;!doctype html&gt;
      &lt;title&gt;{% block title %}{% endblock %} - Flaskr&lt;/title&gt;
      &lt;link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"&gt;
      &lt;nav&gt;
          &lt;h1&gt;Flaskr&lt;/h1&gt;
          &lt;ul&gt;
              {% if g.user %}
              &lt;li&gt;&lt;span&gt;{{ g.user['username'] }}&lt;/span&gt;
                  &lt;li&gt;&lt;a href="{{ url_for('auth.logout') }}"&gt;Log Out&lt;/a&gt;
                      {% else %}
                      &lt;li&gt;&lt;a href="{{ url_for('auth.register') }}"&gt;Register&lt;/a&gt;
                          &lt;li&gt;&lt;a href="{{ url_for('auth.login') }}"&gt;Log In&lt;/a&gt;
                              {% endif %}
          &lt;/ul&gt;
      &lt;/nav&gt;
      &lt;section class="content"&gt;
          &lt;header&gt;
              {% block header %}{% endblock %}
          &lt;/header&gt;
          {% for message in get_flashed_messages() %}
          &lt;div class="flash"&gt;{{ message }}&lt;/div&gt;
          {% endfor %}
          {% block content %}{% endblock %}
      &lt;/section&gt;
</pre>
</div>
</div>
</li>
<li><a id="org807dda1"></a><code>setup.py</code><br />
<ol class="org-ol">
<li><a id="org598a703"></a>配置<br />
<div class="outline-text-6" id="text-4-1-2-5-1">
<p>
<code>setup.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> setuptools <span style="color: #859900; font-weight: bold;">import</span> find_packages, setup

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  setup<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  name=<span style="color: #2aa198;">'flaskr'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  version=<span style="color: #2aa198;">'1.0.0'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  packages=find_packages<span style="color: #b58900;">()</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  include_package_data=<span style="color: #268bd2; font-weight: bold;">True</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  zip_safe=<span style="color: #268bd2; font-weight: bold;">False</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  install_requires=<span style="color: #b58900;">[</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'flask'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">]</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
<code>MANIFEST.in</code> 里的文件都会复制进去
</p>
<pre class="example">
include flaskr/schema.sql
graft flaskr/static
graft flaskr/templates
global-exclude *.pyc
</pre>
</div>
</li>
<li><a id="org161555c"></a>安装<br />
<div class="outline-text-6" id="text-4-1-2-5-2">
<p>
<code>pip install -e .</code>
</p>
</div>
</li>
</ol>
</li>
<li><a id="orgeb6f76f"></a>测试<br />
<ol class="org-ol">
<li><a id="orgbb62c18"></a>安装<br />
<div class="outline-text-6" id="text-4-1-2-6-1">
<div class="org-src-container">
<pre class="src src-bash">       pip install pytest coverage
</pre>
</div>
</div>
</li>
<li><a id="org3d1ba2d"></a>配置<br />
<div class="outline-text-6" id="text-4-1-2-6-2">
<p>
<code>tests/data.sql</code> 临时数据库
</p>
<div class="org-src-container">
<pre class="src src-sql">       <span style="color: #859900; font-weight: bold;">INSERT</span> <span style="color: #859900; font-weight: bold;">INTO</span> <span style="color: #657b83; font-weight: bold;">user</span> <span style="color: #2aa198;">(</span>username, password<span style="color: #2aa198;">)</span>
       <span style="color: #859900; font-weight: bold;">VALUES</span>
       <span style="color: #2aa198;">(</span><span style="color: #2aa198;">'test'</span>, <span style="color: #2aa198;">'pbkdf2:sha256:50000$TCI4GzcX$0de171a4f4dac32e3364c7ddc7c14f3e2fa61f2d17574483f7ffbb431b4acb2f'</span><span style="color: #2aa198;">)</span>,
       <span style="color: #2aa198;">(</span><span style="color: #2aa198;">'other'</span>, <span style="color: #2aa198;">'pbkdf2:sha256:50000$kJPKsz6N$d2d4784f1b030a9761f5ccaeeaca413f27f2ecb76d6168407af962ddce849f79'</span><span style="color: #2aa198;">)</span>;

       <span style="color: #859900; font-weight: bold;">INSERT</span> <span style="color: #859900; font-weight: bold;">INTO</span> post <span style="color: #2aa198;">(</span>title, body, author_id, created<span style="color: #2aa198;">)</span>
       <span style="color: #859900; font-weight: bold;">VALUES</span>
       <span style="color: #2aa198;">(</span><span style="color: #2aa198;">'test title'</span>, <span style="color: #2aa198;">'test'</span> || x<span style="color: #2aa198;">'0a'</span> || <span style="color: #2aa198;">'body'</span>, 1, <span style="color: #2aa198;">'2018-01-01 00:00:00'</span><span style="color: #2aa198;">)</span>;
</pre>
</div>
<p>
<code>tests/conftest.py</code> 配置文件
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> os
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> tempfile

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> pytest
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flaskr <span style="color: #859900; font-weight: bold;">import</span> create_app
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flaskr.db <span style="color: #859900; font-weight: bold;">import</span> get_db, init_db

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> <span style="color: #657b83; font-weight: bold;">open</span><span style="color: #2aa198;">(</span>os.path.join<span style="color: #b58900;">(</span>os.path.dirname<span style="color: #268bd2;">(</span>__file__<span style="color: #268bd2;">)</span>, <span style="color: #2aa198;">'data.sql'</span><span style="color: #b58900;">)</span>, <span style="color: #2aa198;">'rb'</span><span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">as</span> f:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">_data_sql</span> = f.read<span style="color: #2aa198;">()</span>.decode<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'utf8'</span><span style="color: #2aa198;">)</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@pytest.fixture</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">app</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">db_fd</span>, <span style="color: #268bd2;">db_path</span> = tempfile.mkstemp<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">app</span> = create_app<span style="color: #2aa198;">(</span><span style="color: #b58900;">{</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'TESTING'</span>: <span style="color: #268bd2; font-weight: bold;">True</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'DATABASE'</span>: db_path,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">}</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> app.app_context<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  init_db<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  get_db<span style="color: #2aa198;">()</span>.executescript<span style="color: #2aa198;">(</span>_data_sql<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">yield</span> app

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  os.close<span style="color: #2aa198;">(</span>db_fd<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  os.unlink<span style="color: #2aa198;">(</span>db_path<span style="color: #2aa198;">)</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@pytest.fixture</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">client</span><span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> app.test_client<span style="color: #2aa198;">()</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@pytest.fixture</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">runner</span><span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> app.test_cli_runner<span style="color: #2aa198;">()</span>
</pre>
</div>
<ol class="org-ol">
<li><code>tempfile.mkstemp()</code> 创建并打开临时文件</li>
<li><code>TESTING</code> 表示测试模式</li>
</ol>
</div>
</li>
<li><a id="orgf420fd3"></a>工厂函数<br />
<div class="outline-text-6" id="text-4-1-2-6-3">
<p>
<code>tests/test_factory.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flaskr <span style="color: #859900; font-weight: bold;">import</span> create_app


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_config</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> <span style="color: #859900; font-weight: bold;">not</span> create_app<span style="color: #2aa198;">()</span>.testing
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> create_app<span style="color: #2aa198;">(</span><span style="color: #b58900;">{</span><span style="color: #2aa198;">'TESTING'</span>: <span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #b58900;">}</span><span style="color: #2aa198;">)</span>.testing


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_hello</span><span style="color: #2aa198;">(</span>client<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">response</span> = client.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/hello'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> response.data == b<span style="color: #2aa198;">'Hello, World!'</span>
</pre>
</div>
</div>
</li>
<li><a id="orgac2a204"></a>数据库<br />
<div class="outline-text-6" id="text-4-1-2-6-4">
<p>
<code>tests/test_db.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> sqlite3

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> pytest
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flaskr.db <span style="color: #859900; font-weight: bold;">import</span> get_db


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_get_close_db</span><span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> app.app_context<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">db</span> = get_db<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> db <span style="color: #859900; font-weight: bold;">is</span> get_db<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> pytest.raises<span style="color: #2aa198;">(</span>sqlite3.ProgrammingError<span style="color: #2aa198;">)</span> <span style="color: #859900; font-weight: bold;">as</span> e:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.execute<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'SELECT 1'</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> <span style="color: #2aa198;">'closed'</span> <span style="color: #859900; font-weight: bold;">in</span> <span style="color: #657b83; font-weight: bold;">str</span><span style="color: #2aa198;">(</span>e<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_init_db_command</span><span style="color: #2aa198;">(</span>runner, monkeypatch<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Recorder</span><span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">object</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">called</span> = <span style="color: #268bd2; font-weight: bold;">False</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">fake_init_db</span><span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">Recorder.called</span> = <span style="color: #268bd2; font-weight: bold;">True</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  monkeypatch.<span style="color: #657b83; font-weight: bold;">setattr</span><span style="color: #2aa198;">(</span><span style="color: #2aa198;">'flaskr.db.init_db'</span>, fake_init_db<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">result</span> = runner.invoke<span style="color: #2aa198;">(</span>args=<span style="color: #b58900;">[</span><span style="color: #2aa198;">'init-db'</span><span style="color: #b58900;">]</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> <span style="color: #2aa198;">'Initialized'</span> <span style="color: #859900; font-weight: bold;">in</span> result.output
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> Recorder.called
</pre>
</div>
</div>
</li>
<li><a id="org9aa3d25"></a>身份验证<br />
<div class="outline-text-6" id="text-4-1-2-6-5">
<p>
<code>tests/conftest.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">AuthActions</span><span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">object</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__init__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, client<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">self</span>._client = client

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">login</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, username=<span style="color: #2aa198;">'test'</span>, password=<span style="color: #2aa198;">'test'</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">self</span>._client.post<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'/auth/login'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  data=<span style="color: #b58900;">{</span><span style="color: #2aa198;">'username'</span>: username, <span style="color: #2aa198;">'password'</span>: password<span style="color: #b58900;">}</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">logout</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #859900; font-weight: bold;">self</span>._client.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/auth/logout'</span><span style="color: #2aa198;">)</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@pytest.fixture</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">auth</span><span style="color: #2aa198;">(</span>client<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> AuthActions<span style="color: #2aa198;">(</span>client<span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
<code>tests/test_auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> pytest
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> g, session
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> flaskr.db <span style="color: #859900; font-weight: bold;">import</span> get_db


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_register</span><span style="color: #2aa198;">(</span>client, app<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> client.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/auth/register'</span><span style="color: #2aa198;">)</span>.status_code == 200
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">response</span> = client.post<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'/auth/register'</span>, data=<span style="color: #b58900;">{</span><span style="color: #2aa198;">'username'</span>: <span style="color: #2aa198;">'a'</span>, <span style="color: #2aa198;">'password'</span>: <span style="color: #2aa198;">'a'</span><span style="color: #b58900;">}</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> <span style="color: #2aa198;">'http://localhost/auth/login'</span> == response.headers<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'Location'</span><span style="color: #2aa198;">]</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> app.app_context<span style="color: #2aa198;">()</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> get_db<span style="color: #2aa198;">()</span>.execute<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">"select * from user where username = 'a'"</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>.fetchone<span style="color: #2aa198;">()</span> <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@pytest.mark.parametrize</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">'username'</span>, <span style="color: #2aa198;">'password'</span>, <span style="color: #2aa198;">'message'</span><span style="color: #b58900;">)</span>, <span style="color: #b58900;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">(</span><span style="color: #2aa198;">''</span>, <span style="color: #2aa198;">''</span>, b<span style="color: #2aa198;">'Username is required.'</span><span style="color: #268bd2;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">(</span><span style="color: #2aa198;">'a'</span>, <span style="color: #2aa198;">''</span>, b<span style="color: #2aa198;">'Password is required.'</span><span style="color: #268bd2;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">(</span><span style="color: #2aa198;">'test'</span>, <span style="color: #2aa198;">'test'</span>, b<span style="color: #2aa198;">'already registered'</span><span style="color: #268bd2;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_register_validate_input</span><span style="color: #2aa198;">(</span>client, username, password, message<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">response</span> = client.post<span style="color: #2aa198;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">'/auth/register'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  data=<span style="color: #b58900;">{</span><span style="color: #2aa198;">'username'</span>: username, <span style="color: #2aa198;">'password'</span>: password<span style="color: #b58900;">}</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> message <span style="color: #859900; font-weight: bold;">in</span> response.data
</pre>
</div>
<ol class="org-ol">
<li><code>client.get()</code> 创建并返回一个 <code>GET</code> 请求</li>
</ol>
<p>
<code>tests/test_auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_login</span><span style="color: #2aa198;">(</span>client, auth<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> client.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/auth/login'</span><span style="color: #2aa198;">)</span>.status_code == 200
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">response</span> = auth.login<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> response.headers<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'Location'</span><span style="color: #2aa198;">]</span> == <span style="color: #2aa198;">'http://localhost/'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> client:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  client.get<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> session<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'user_id'</span><span style="color: #2aa198;">]</span> == 1
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> g.user<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'username'</span><span style="color: #2aa198;">]</span> == <span style="color: #2aa198;">'test'</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">@pytest.mark.parametrize</span><span style="color: #2aa198;">(</span><span style="color: #b58900;">(</span><span style="color: #2aa198;">'username'</span>, <span style="color: #2aa198;">'password'</span>, <span style="color: #2aa198;">'message'</span><span style="color: #b58900;">)</span>, <span style="color: #b58900;">(</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">(</span><span style="color: #2aa198;">'a'</span>, <span style="color: #2aa198;">'test'</span>, b<span style="color: #2aa198;">'Incorrect username.'</span><span style="color: #268bd2;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">(</span><span style="color: #2aa198;">'test'</span>, <span style="color: #2aa198;">'a'</span>, b<span style="color: #2aa198;">'Incorrect password.'</span><span style="color: #268bd2;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_login_validate_input</span><span style="color: #2aa198;">(</span>auth, username, password, message<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">response</span> = auth.login<span style="color: #2aa198;">(</span>username, password<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> message <span style="color: #859900; font-weight: bold;">in</span> response.data
</pre>
</div>
<p>
<code>tests/test_auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">test_logout</span><span style="color: #2aa198;">(</span>client, auth<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  auth.login<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">with</span> client:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  auth.logout<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">assert</span> <span style="color: #2aa198;">'user_id'</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #859900; font-weight: bold;">in</span> session
</pre>
</div>
</div>
</li>
<li><a id="org27eb85f"></a>运行测试<br />
<div class="outline-text-6" id="text-4-1-2-6-6">
<p>
<code>setup.cfg</code>
</p>
<div class="org-src-container">
<pre class="src src-text">       [tool:pytest]
       testpaths = tests

       [coverage:run]
       branch = True
       source = flaskr
</pre>
</div>
<p>
运行测试 <code>pytest</code>
代码覆盖率 <code>coverage run -m pytest</code>
报告 <code>coverage report</code>
</p>
</div>
</li>
</ol>
</li>
<li><a id="org018d6dc"></a>发布<br />
<ol class="org-ol">
<li><a id="org037096e"></a>构建与安装<br />
<div class="outline-text-6" id="text-4-1-2-7-1">
<p>
<code>pip install wheel</code>
<code>python setup.py bdist_wheel</code>
</p>
</div>
</li>
<li><a id="org44061ff"></a>配置密钥<br />
<div class="outline-text-6" id="text-4-1-2-7-2">
<div class="org-src-container">
<pre class="src src-shell">       python -c <span style="color: #2aa198;">'import os; print(os.urandom(16))'</span>
       b<span style="color: #2aa198;">'_5#y2L"F4Q8z\n\xec]/'</span>
</pre>
</div>
<p>
<code>venv/var/flaskr-instance/config.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">SECRET_KEY</span> = b<span style="color: #2aa198;">'_5#y2L"F4Q8z\n\xec]/'</span>
</pre>
</div>
</div>
</li>
<li><a id="org6521fd9"></a>运行<br />
<div class="outline-text-6" id="text-4-1-2-7-3">
<p>
不要直接 <code>flask run</code>, 用别的 WSGI 服务器
<code>pip install waitress</code>
<code>waitress-serve --call 'flaskr:create_app'</code>
</p>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgd5972bb" class="outline-4">
<h4 id="orgd5972bb"><span class="section-number-4">4.1.3</span> 插件</h4>
<div class="outline-text-4" id="text-4-1-3">
</div>
<ol class="org-ol">
<li><a id="orgdaaa13c"></a><a href="http://github.com/maxcountryman/flask-login/">Flask-Login</a><br /></li>
<li><a id="org8660dc1"></a><a href="http://github.com/flask-restful/flask-restful/">Flask-RESTful</a><br /></li>
<li><a id="org6ecfd90"></a><a href="http://github.com/mitsuhiko/flask-sqlalchemy/">Flask-SQLAlchemy</a><br /></li>
</ol>
</div>
</div>
<div id="outline-container-orge5fb3c3" class="outline-3">
<h3 id="orge5fb3c3"><span class="section-number-3">4.2</span> flask-restful 快速创建 RESTful api 服务器</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-orgf25d11c" class="outline-4">
<h4 id="orgf25d11c"><span class="section-number-4">4.2.1</span> 基本使用</h4>
<div class="outline-text-4" id="text-4-2-1">
</div>
<ol class="org-ol">
<li><a id="orgb762921"></a>完整的程序例子<br />
<div class="outline-text-5" id="text-4-2-1-1">
<ol class="org-ol">
<li>首先要导入flask 和 flask-restful 库, 并创建 flask app 和 flask-restful api 类.</li>
<li>创建资源类和需要响应的方法.</li>
<li>将资源类和请求url加入到 api 类里.</li>
<li><p>
运行主循环 <code>python api.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">from</span> flask_restful <span style="color: #859900; font-weight: bold;">import</span> Resource, Api

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #268bd2;">api</span> = Api<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">HelloWorld</span><span style="color: #2aa198;">(</span>Resource<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'hello'</span>: <span style="color: #2aa198;">'world'</span><span style="color: #2aa198;">}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>api.add_resource<span style="color: #2aa198;">(</span>HelloWorld, <span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>app.run<span style="color: #2aa198;">(</span>debug=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
</pre>
</div></li>
</ol>
</div>
</li>
<li><a id="org6b2d8b7"></a>路由<br />
<div class="outline-text-5" id="text-4-2-1-2">
<ol class="org-ol">
<li><p>
在加入资源类时, 路由规则与 flask 相同,也可以将匹配到的地址作为函数的参数
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask, request
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">from</span> flask_restful <span style="color: #859900; font-weight: bold;">import</span> Resource, Api

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #268bd2;">api</span> = Api<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #268bd2;">todos</span> = <span style="color: #2aa198;">{}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">TodoSimple</span><span style="color: #2aa198;">(</span>Resource<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, todo_id<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">{</span>todo_id: todos<span style="color: #b58900;">[</span>todo_id<span style="color: #b58900;">]</span><span style="color: #2aa198;">}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">put</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, todo_id<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #268bd2;">todos</span><span style="color: #2aa198;">[</span>todo_id<span style="color: #2aa198;">]</span> = request.form<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'data'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">{</span>todo_id: todos<span style="color: #b58900;">[</span>todo_id<span style="color: #b58900;">]</span><span style="color: #2aa198;">}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>api.add_resource<span style="color: #2aa198;">(</span>TodoSimple, <span style="color: #2aa198;">'/&lt;string:todo_id&gt;'</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">if</span> <span style="color: #657b83; font-weight: bold;">__name__</span> == <span style="color: #2aa198;">'__main__'</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>app.run<span style="color: #2aa198;">(</span>debug=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
</pre>
</div></li>

<li><p>
函数同样可以有多种返回值
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Todo1</span><span style="color: #2aa198;">(</span>Resource<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Default to 200 OK</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'task'</span>: <span style="color: #2aa198;">'Hello world'</span><span style="color: #2aa198;">}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Todo2</span><span style="color: #2aa198;">(</span>Resource<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Set the response code to 201</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'task'</span>: <span style="color: #2aa198;">'Hello world'</span><span style="color: #2aa198;">}</span>, 201

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Todo3</span><span style="color: #2aa198;">(</span>Resource<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">Set the response code to 201 and return custom headers</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span><span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'task'</span>: <span style="color: #2aa198;">'Hello world'</span><span style="color: #2aa198;">}</span>, 201, <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'Etag'</span>: <span style="color: #2aa198;">'some-opaque-string'</span><span style="color: #2aa198;">}</span>
</pre>
</div></li>

<li><p>
同一个资源可以有多个地址,还可以只匹配一部分
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>api.add_resource<span style="color: #2aa198;">(</span>HelloWorld,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">'/'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">'/hello'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>api.add_resource<span style="color: #2aa198;">(</span>Todo,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">'/todo/&lt;int:todo_id&gt;'</span>, endpoint=<span style="color: #2aa198;">'todo_ep'</span><span style="color: #2aa198;">)</span>
</pre>
</div></li>
</ol>
</div>
</li>

<li><a id="org6d6ffcd"></a>参数解析<br />
<div class="outline-text-5" id="text-4-2-1-3">
<p>
可以在解析路由时进行有效性验证
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> flask_restful <span style="color: #859900; font-weight: bold;">import</span> reqparse

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">parser</span> = reqparse.RequestParser<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> parser.add_argument<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'rate'</span>, <span style="color: #657b83; font-weight: bold;">type</span>=<span style="color: #657b83; font-weight: bold;">int</span>, <span style="color: #657b83; font-weight: bold;">help</span>=<span style="color: #2aa198;">'Rate to charge for this resource'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">args</span> = parser.parse_args<span style="color: #2aa198;">()</span>
</pre>
</div>
</div>
</li>

<li><a id="orgb44e5ae"></a>数据格式<br />
<div class="outline-text-5" id="text-4-2-1-4">
<p>
发送数据结构很容易,但发送python对象就比较麻烦了.
使用 <code>fields</code> 和 <code>marshal_with</code> 可以解决发送python 对象的麻烦问题.
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> flask_restful <span style="color: #859900; font-weight: bold;">import</span> fields, marshal_with

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">resource_fields</span> = <span style="color: #2aa198;">{</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">'task'</span>:   fields.String,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">'uri'</span>:    fields.Url<span style="color: #b58900;">(</span><span style="color: #2aa198;">'todo_ep'</span><span style="color: #b58900;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">}</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">TodoDao</span><span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">object</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__init__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, todo_id, task<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">self</span>.todo_id = todo_id
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">self</span>.task = task

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">This field will not be sent in the response</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">self</span>.status = <span style="color: #2aa198;">'active'</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Todo</span><span style="color: #2aa198;">(</span>Resource<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #b58900;">@marshal_with</span><span style="color: #2aa198;">(</span>resource_fields<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, **kwargs<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">return</span> TodoDao<span style="color: #2aa198;">(</span>todo_id=<span style="color: #2aa198;">'my_todo'</span>, task=<span style="color: #2aa198;">'Remember the milk'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgce8121b" class="outline-3">
<h3 id="orgce8121b"><span class="section-number-3">4.3</span> Flask-SQLAlchemy ORM 对象关系映射</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgc9bd8d7" class="outline-4">
<h4 id="orgc9bd8d7"><span class="section-number-4">4.3.1</span> 基本使用</h4>
<div class="outline-text-4" id="text-4-3-1">
</div>
<ol class="org-ol">
<li><a id="org7f5653d"></a>最小示例<br />
<div class="outline-text-5" id="text-4-3-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> flask <span style="color: #859900; font-weight: bold;">import</span> Flask
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> flask_sqlalchemy <span style="color: #859900; font-weight: bold;">import</span> SQLAlchemy

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">app</span> = Flask<span style="color: #2aa198;">(</span><span style="color: #657b83; font-weight: bold;">__name__</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">app.config</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'SQLALCHEMY_DATABASE_URI'</span><span style="color: #2aa198;">]</span> = <span style="color: #2aa198;">'sqlite:////tmp/test.db'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">db</span> = SQLAlchemy<span style="color: #2aa198;">(</span>app<span style="color: #2aa198;">)</span>


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">User</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #657b83; font-weight: bold;">id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, primary_key=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">username</span> = db.Column<span style="color: #2aa198;">(</span>db.String<span style="color: #b58900;">(</span>80<span style="color: #b58900;">)</span>, unique=<span style="color: #268bd2; font-weight: bold;">True</span>, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">email</span> = db.Column<span style="color: #2aa198;">(</span>db.String<span style="color: #b58900;">(</span>120<span style="color: #b58900;">)</span>, unique=<span style="color: #268bd2; font-weight: bold;">True</span>, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__repr__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;User %r&gt;'</span> % <span style="color: #859900; font-weight: bold;">self</span>.username
</pre>
</div>
<ol class="org-ol">
<li>导入 <code>flask_sqlalchemy</code> 之后就得到了该有的各种东西</li>
<li><code>Model</code> 类可用于描述模型</li>
</ol>
</div>
<ol class="org-ol">
<li><a id="org73f2ffd"></a>创建数据库<br />
<div class="outline-text-6" id="text-4-3-1-1-1">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> yourapplication <span style="color: #859900; font-weight: bold;">import</span> db
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.create_all<span style="color: #2aa198;">()</span>
</pre>
</div>
</div>
</li>
<li><a id="org8c65080"></a>创建数据<br />
<div class="outline-text-6" id="text-4-3-1-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> yourapplication <span style="color: #859900; font-weight: bold;">import</span> User
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">admin</span> = User<span style="color: #2aa198;">(</span>username=<span style="color: #2aa198;">'admin'</span>, email=<span style="color: #2aa198;">'admin@example.com'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">guest</span> = User<span style="color: #2aa198;">(</span>username=<span style="color: #2aa198;">'guest'</span>, email=<span style="color: #2aa198;">'guest@example.com'</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
<li><a id="org06c1663"></a>写入到数据库<br />
<div class="outline-text-6" id="text-4-3-1-1-3">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.session.add<span style="color: #2aa198;">(</span>admin<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.session.add<span style="color: #2aa198;">(</span>guest<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  db.session.commit<span style="color: #2aa198;">()</span>
</pre>
</div>
</div>
</li>
<li><a id="orgde53981"></a>查询数据<br />
<div class="outline-text-6" id="text-4-3-1-1-4">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  User.query.<span style="color: #657b83; font-weight: bold;">all</span><span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">&gt; [&lt;User u'admin'&gt;, &lt;User u'guest'&gt;]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  User.query.filter_by<span style="color: #2aa198;">(</span>username=<span style="color: #2aa198;">'admin'</span><span style="color: #2aa198;">)</span>.first<span style="color: #2aa198;">()</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">&gt; &lt;User u'admin'&gt;</span>
</pre>
</div>
</div>
</li>
<li><a id="org09272a0"></a>重载构造函数<br />
<div class="outline-text-6" id="text-4-3-1-1-5">
<p>
默认已经提供了一个构造函数,可以这样重载它
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Foo</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">...</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__init__</span><span style="color: #2aa198;">(</span>**kwargs<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #657b83; font-weight: bold;">super</span><span style="color: #2aa198;">(</span>Foo, <span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>.__init__<span style="color: #2aa198;">(</span>**kwargs<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">do custom stuff</span>
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orgced8509"></a>两个表之间的关系<br />
<div class="outline-text-5" id="text-4-3-1-2">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> datetime <span style="color: #859900; font-weight: bold;">import</span> datetime


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Post</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #657b83; font-weight: bold;">id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, primary_key=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">title</span> = db.Column<span style="color: #2aa198;">(</span>db.String<span style="color: #b58900;">(</span>80<span style="color: #b58900;">)</span>, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">body</span> = db.Column<span style="color: #2aa198;">(</span>db.Text, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">pub_date</span> = db.Column<span style="color: #2aa198;">(</span>db.DateTime, nullable=<span style="color: #268bd2; font-weight: bold;">False</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  default=datetime.utcnow<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">category_id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, db.ForeignKey<span style="color: #b58900;">(</span><span style="color: #2aa198;">'category.id'</span><span style="color: #b58900;">)</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">category</span> = db.relationship<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'Category'</span>,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>backref=db.backref<span style="color: #b58900;">(</span><span style="color: #2aa198;">'posts'</span>, lazy=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__repr__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;Post %r&gt;'</span> % <span style="color: #859900; font-weight: bold;">self</span>.title


<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">Category</span><span style="color: #2aa198;">(</span>db.Model<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #657b83; font-weight: bold;">id</span> = db.Column<span style="color: #2aa198;">(</span>db.Integer, primary_key=<span style="color: #268bd2; font-weight: bold;">True</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">name</span> = db.Column<span style="color: #2aa198;">(</span>db.String<span style="color: #b58900;">(</span>50<span style="color: #b58900;">)</span>, nullable=<span style="color: #268bd2; font-weight: bold;">False</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">__repr__</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">return</span> <span style="color: #2aa198;">'&lt;Category %r&gt;'</span> % <span style="color: #859900; font-weight: bold;">self</span>.name
</pre>
</div>
<p>
创建一些数据,会自动加入到关联的表里
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">py</span> = Category<span style="color: #2aa198;">(</span>name=<span style="color: #2aa198;">'Python'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> Post<span style="color: #2aa198;">(</span>title=<span style="color: #2aa198;">'Hello Python!'</span>, body=<span style="color: #2aa198;">'Python is pretty cool'</span>, category=py<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">p</span> = Post<span style="color: #2aa198;">(</span>title=<span style="color: #2aa198;">'Snakes'</span>, body=<span style="color: #2aa198;">'Ssssssss'</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> py.posts.append<span style="color: #2aa198;">(</span>p<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> db.session.add<span style="color: #2aa198;">(</span>py<span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
在一次查询中加载所有
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">from</span> sqlalchemy.orm <span style="color: #859900; font-weight: bold;">import</span> joinedload
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">query</span> = Category.query.options<span style="color: #2aa198;">(</span>joinedload<span style="color: #b58900;">(</span><span style="color: #2aa198;">'posts'</span><span style="color: #b58900;">)</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">for</span> category <span style="color: #859900; font-weight: bold;">in</span> query:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">print</span> category, category.posts
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org5a3bbcb" class="outline-2">
<h2 id="org5a3bbcb"><span class="section-number-2">5</span> scrapy</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org572c3af" class="outline-3">
<h3 id="org572c3af"><span class="section-number-3">5.1</span> 基本使用</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orgf8519f0" class="outline-4">
<h4 id="orgf8519f0"><span class="section-number-4">5.1.1</span> 创建项目</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
用命令, <code>scrapy startproject PROJECT_NAME</code> ,会自动创建文件目录结构
</p>
</div>
</div>
<div id="outline-container-org9085cb2" class="outline-4">
<h4 id="org9085cb2"><span class="section-number-4">5.1.2</span> 获取下一页以及构造item</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
<code>PROJECT_NAME/PROJECT_NAME/spiders/</code> 文件夹中利用 
scrapy genspider name domin~ 创建空文件模板
<code>parse</code> 函数中写分析网页的代码
用 <code>response.xpath('//div').extract()</code> 解析网址
</p>
</div>
<ol class="org-ol">
<li><a id="orga0d8508"></a>构造item的方法<br />
<div class="outline-text-5" id="text-5-1-2-1">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">yield</span> <span style="color: #2aa198;">{</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">"image_urls"</span>:image_urls,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">"referer_url"</span>:response.url,
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #2aa198;">}</span>
</pre>
</div>
<p>
用 <code>yield</code> 返回一个 <code>map</code> 就会自动作为item处理
</p>
</div>
</li>
<li><a id="org5897aa4"></a>向下一页的方法<br />
<div class="outline-text-5" id="text-5-1-2-2">
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">for</span> ni <span style="color: #859900; font-weight: bold;">in</span> response.xpath<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'//a'</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #2aa198;">(</span>ni.xpath<span style="color: #b58900;">(</span><span style="color: #2aa198;">'text()="&#19979;&#19968;&#39029;"'</span><span style="color: #b58900;">)</span>.extract_first<span style="color: #b58900;">()</span> == <span style="color: #2aa198;">'1'</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">and</span> ni.xpath<span style="color: #b58900;">(</span><span style="color: #2aa198;">'@href'</span><span style="color: #b58900;">)</span> <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">print</span><span style="color: #2aa198;">(</span>ni<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">next_page</span> = ni.xpath<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'@href'</span><span style="color: #2aa198;">)</span>.extract_first<span style="color: #2aa198;">()</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">if</span> next_page <span style="color: #859900; font-weight: bold;">is</span> <span style="color: #859900; font-weight: bold;">not</span> <span style="color: #268bd2; font-weight: bold;">None</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #268bd2;">next_page</span> = response.urljoin<span style="color: #2aa198;">(</span>next_page<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span> <span style="color: #859900; font-weight: bold;">yield</span> scrapy.Request<span style="color: #2aa198;">(</span>next_page, callback=<span style="color: #859900; font-weight: bold;">self</span>.parse<span style="color: #2aa198;">)</span>
</pre>
</div>
<p>
只要 <code>yield</code> 一个 <code>scrapy.Request</code> 即可
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org37661d7" class="outline-4">
<h4 id="org37661d7"><span class="section-number-4">5.1.3</span> 利用 <code>ImagesPipeline</code> 保存图片的方法</h4>
<div class="outline-text-4" id="text-5-1-3">
</div>
<ol class="org-ol">
<li><a id="orge527533"></a>使用默认版本的 <code>ImagesPipeline</code><br />
<div class="outline-text-5" id="text-5-1-3-1">
<ol class="org-ol">
<li>在item里返回 <code>"image_urls":["http://","..."]</code> 一系列图片地址即可</li>
<li>在设置里 <code>settings.py</code> 加上</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">ITEM_PIPELINES</span> = <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'scrapy.pipelines.images.ImagesPipeline'</span>: 1<span style="color: #2aa198;">}</span><span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">&#21551;&#29992;&#20869;&#32622;&#22270;&#29255;&#19979;&#36733;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">IMAGES_STORE</span> = <span style="color: #2aa198;">'/home/download_picture/img'</span><span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">&#20445;&#23384;&#30340;&#20301;&#32622;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">MEDIA_ALLOW_REDIRECTS</span> = <span style="color: #268bd2; font-weight: bold;">True</span>
</pre>
</div>
</div>
</li>
<li><a id="orgbe069f2"></a>使用自定义版本<br />
<div class="outline-text-5" id="text-5-1-3-2">
<ol class="org-ol">
<li>item 可以随意设置</li>
<li>在 <code>settings.py`里的`ITEMPIPELINES</code> 改成</li>
</ol>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">ITEM_PIPELINES</span> = <span style="color: #2aa198;">{</span><span style="color: #2aa198;">'MYPROJECT.pipelines.MYPROJECTImagesPipeline'</span>: 1<span style="color: #2aa198;">}</span><span style="color: #93a1a1;">#</span><span style="color: #93a1a1;">&#20351;&#29992;&#33258;&#32534;&#22270;&#29255;&#19979;&#36733;</span>
</pre>
</div>
<p>
基本的自编下载在 <code>pipelines.py</code> 里加上:
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> scrapy
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> scrapy.pipelines.images <span style="color: #859900; font-weight: bold;">import</span> ImagesPipeline
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> scrapy.exceptions <span style="color: #859900; font-weight: bold;">import</span> DropItem

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">MYPROJECTImagesPipeline</span><span style="color: #2aa198;">(</span>ImagesPipeline<span style="color: #2aa198;">)</span>:

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get_media_requests</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, item, info<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">"""&#22788;&#29702;item"""</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">for</span> image_url <span style="color: #859900; font-weight: bold;">in</span> item<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'image_urls'</span><span style="color: #2aa198;">]</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">yield</span> scrapy.Request<span style="color: #2aa198;">(</span>image_url<span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">item_completed</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, results, item, info<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #2aa198;">"""&#23436;&#25104;&#21518;&#25191;&#34892;"""</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">image_paths</span> = <span style="color: #2aa198;">[</span>x<span style="color: #b58900;">[</span><span style="color: #2aa198;">'path'</span><span style="color: #b58900;">]</span> <span style="color: #859900; font-weight: bold;">for</span> ok, x <span style="color: #859900; font-weight: bold;">in</span> results <span style="color: #859900; font-weight: bold;">if</span> ok<span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">if</span> <span style="color: #859900; font-weight: bold;">not</span> image_paths:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">raise</span> DropItem<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"Item contains no images"</span><span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">item</span><span style="color: #2aa198;">[</span><span style="color: #2aa198;">'image_paths'</span><span style="color: #2aa198;">]</span> = image_paths
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> item

</pre>
</div>
</div>
</li>
<li><a id="org29310b0"></a>重命名图片名<br />
<div class="outline-text-5" id="text-5-1-3-3">
<p>
重载方法 <code>file_path</code>
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">import</span> re
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> scrapy.pipelines.images <span style="color: #859900; font-weight: bold;">import</span> ImagesPipeline
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">from</span> scrapy <span style="color: #859900; font-weight: bold;">import</span> Request

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">class</span> <span style="color: #b58900;">ImagesrenamePipeline</span><span style="color: #2aa198;">(</span>ImagesPipeline<span style="color: #2aa198;">)</span>:

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">get_media_requests</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, item, info<span style="color: #2aa198;">)</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#24490;&#29615;&#27599;&#19968;&#24352;&#22270;&#29255;&#22320;&#22336;&#19979;&#36733;&#65292;&#33509;&#20256;&#36807;&#26469;&#30340;&#19981;&#26159;&#38598;&#21512;&#21017;&#26080;&#38656;&#24490;&#29615;&#30452;&#25509;yield</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">for</span> image_url <span style="color: #859900; font-weight: bold;">in</span> item<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'imgurl'</span><span style="color: #2aa198;">]</span>:
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">meta&#37324;&#38754;&#30340;&#25968;&#25454;&#26159;&#20174;spider&#33719;&#21462;&#65292;&#28982;&#21518;&#36890;&#36807;meta&#20256;&#36882;&#32473;&#19979;&#38754;&#26041;&#27861;&#65306;file_path</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">yield</span> Request<span style="color: #2aa198;">(</span>image_url,meta=<span style="color: #b58900;">{</span><span style="color: #2aa198;">'name'</span>:item<span style="color: #268bd2;">[</span><span style="color: #2aa198;">'imgname'</span><span style="color: #268bd2;">]</span><span style="color: #b58900;">}</span><span style="color: #2aa198;">)</span>

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#37325;&#21629;&#21517;&#65292;&#33509;&#19981;&#37325;&#20889;&#36825;&#20989;&#25968;&#65292;&#22270;&#29255;&#21517;&#20026;&#21704;&#24076;&#65292;&#23601;&#26159;&#19968;&#20018;&#20081;&#19971;&#20843;&#31967;&#30340;&#21517;&#23383;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">def</span> <span style="color: #268bd2;">file_path</span><span style="color: #2aa198;">(</span><span style="color: #859900; font-weight: bold;">self</span>, request, response=<span style="color: #268bd2; font-weight: bold;">None</span>, info=<span style="color: #268bd2; font-weight: bold;">None</span><span style="color: #2aa198;">)</span>:

<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#25552;&#21462;url&#21069;&#38754;&#21517;&#31216;&#20316;&#20026;&#22270;&#29255;&#21517;&#12290;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">image_guid</span> = request.url.split<span style="color: #2aa198;">(</span><span style="color: #2aa198;">'/'</span><span style="color: #2aa198;">)[</span>-1<span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#25509;&#25910;&#19978;&#38754;meta&#20256;&#36882;&#36807;&#26469;&#30340;&#22270;&#29255;&#21517;&#31216;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">name</span> = request.meta<span style="color: #2aa198;">[</span><span style="color: #2aa198;">'name'</span><span style="color: #2aa198;">]</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#36807;&#28388;windows&#23383;&#31526;&#20018;&#65292;&#19981;&#32463;&#36807;&#36825;&#20040;&#19968;&#20010;&#27493;&#39588;&#65292;&#20320;&#20250;&#21457;&#29616;&#26377;&#20081;&#30721;&#25110;&#26080;&#27861;&#19979;&#36733;</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">name</span> = re.sub<span style="color: #2aa198;">(</span>r<span style="color: #2aa198;">'[&#65311;\\*|&#8220;&lt;&gt;:/]'</span>, <span style="color: #2aa198;">''</span>, name<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #93a1a1;"># </span><span style="color: #93a1a1;">&#20998;&#25991;&#20214;&#22841;&#23384;&#20648;&#30340;&#20851;&#38190;&#65306;{0}&#23545;&#24212;&#30528;name&#65307;{1}&#23545;&#24212;&#30528;image_guid</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #268bd2;">filename</span> = u<span style="color: #2aa198;">'{0}/{1}'</span>.<span style="color: #657b83; font-weight: bold;">format</span><span style="color: #2aa198;">(</span>name, image_guid<span style="color: #2aa198;">)</span>
<span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>   <span style="background-color: #eee8d5;"> </span>  <span style="color: #859900; font-weight: bold;">return</span> filename
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf3fd2c6" class="outline-4">
<h4 id="orgf3fd2c6"><span class="section-number-4">5.1.4</span> 交互式试探解析网页</h4>
<div class="outline-text-4" id="text-5-1-4">
</div>
<ol class="org-ol">
<li><a id="org99fa15b"></a>配置<br />
<ol class="org-ol">
<li><a id="orgc255e8b"></a>使用 ipython<br />
<div class="outline-text-6" id="text-5-1-4-1-1">
<p>
在 <code>scrapy.cfg</code> 里加入
</p>
<div class="org-src-container">
<pre class="src src-python"><span style="color: #2aa198;">[</span>settings<span style="color: #2aa198;">]</span>
<span style="color: #268bd2;">shell</span> = bpython
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orgdd19cdc"></a>打开 url<br />
<div class="outline-text-5" id="text-5-1-4-2">
<div class="org-src-container">
<pre class="src src-bash">scrapy shell file:///absolute/path/to/file.html
</pre>
</div>
</div>
</li>
<li><a id="orgb1f8a07"></a>获取资源<br />
<div class="outline-text-5" id="text-5-1-4-3">
<div class="org-src-container">
<pre class="src src-python">fetch<span style="color: #2aa198;">(</span><span style="color: #2aa198;">"url"</span><span style="color: #2aa198;">)</span>
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: chimez</p>
<p class="date">Created: 2020-09-27 Sun 17:24</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
