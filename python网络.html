<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-12-19 Sat 14:08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>python网络</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="chimez" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="static/readtheorg_theme/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="static/readtheorg_theme/css/readtheorg.css"/>
<script type="text/javascript" static="static/lib/js/jquery.min.js"></script>
<script type="text/javascript" static="static/lib/js/bootstrap.min.js"></script>
<script type="text/javascript" static="static/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" static="static/readtheorg_theme/js/readtheorg.js"></script>
<style> #content{max-width:1800px;}</style>
<style> p{max-width:800px;}</style>
<style> li{max-width:800px;}</style
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">python网络</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org63dd3f1">1. xmlrpc</a>
<ul>
<li><a href="#orgaa0bee9">1.1. 服务端</a></li>
<li><a href="#org7a4c683">1.2. 客户端</a></li>
</ul>
</li>
<li><a href="#orgc326ad2">2. Requests 与 Requests-HTML</a>
<ul>
<li><a href="#org7967cef">2.1. 安装与基本配置</a></li>
<li><a href="#orgaaca8df">2.2. 基本使用</a></li>
<li><a href="#org1b858fe">2.3. 使用 socks5 代理</a></li>
<li><a href="#org4fe81bb">2.4. 下载文件</a></li>
</ul>
</li>
<li><a href="#org39909fc">3. BeautifulSoup4</a>
<ul>
<li><a href="#org7eabae9">3.1. 安装</a></li>
<li><a href="#orgbdeee6d">3.2. 标签的使用</a></li>
<li><a href="#orgc1de9ff">3.3. 标签的遍历</a></li>
<li><a href="#org9b76b29">3.4. 标签的寻找</a></li>
<li><a href="#org72d93e3">3.5. css选择器</a></li>
</ul>
</li>
<li><a href="#org9b16def">4. flask</a>
<ul>
<li><a href="#orgdd1bb41">4.1. Flask 框架学习记录</a>
<ul>
<li><a href="#org1a815fe">4.1.1. 基本使用</a></li>
<li><a href="#orgc074e68">4.1.2. 指南</a></li>
<li><a href="#orgd5972bb">4.1.3. 插件</a></li>
</ul>
</li>
<li><a href="#orge5fb3c3">4.2. flask-restful 快速创建 RESTful api 服务器</a>
<ul>
<li><a href="#orged12508">4.2.1. 基本使用</a></li>
</ul>
</li>
<li><a href="#orgce8121b">4.3. Flask-SQLAlchemy ORM 对象关系映射</a>
<ul>
<li><a href="#orgf208ccf">4.3.1. 基本使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5a3bbcb">5. scrapy</a>
<ul>
<li><a href="#org9c9a814">5.1. 基本使用</a>
<ul>
<li><a href="#orgf8519f0">5.1.1. 创建项目</a></li>
<li><a href="#org9085cb2">5.1.2. 获取下一页以及构造item</a></li>
<li><a href="#org37661d7">5.1.3. 利用 <code>ImagesPipeline</code> 保存图片的方法</a></li>
<li><a href="#orgf3fd2c6">5.1.4. 交互式试探解析网页</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>





<div id="outline-container-org63dd3f1" class="outline-2">
<h2 id="org63dd3f1"><span class="section-number-2">1</span> xmlrpc</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgaa0bee9" class="outline-3">
<h3 id="orgaa0bee9"><span class="section-number-3">1.1</span> 服务端</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-python">from xmlrpc.server import SimpleXMLRPCServer

QUIT_SERVER = False


def is_even(n):
    return n % 2 == 0


def kill():
    global QUIT_SERVER
    QUIT_SERVER = True
    return 1


def main():
    server = SimpleXMLRPCServer(("localhost", 8000))
    print("Listening on port 8000...")
    server.register_function(is_even, "is_even")
    server.register_function(kill, "kill")
    global QUIT_SERVER
    while not QUIT_SERVER:
	server.handle_request()

if __name__ == '__main__':
    main()
</pre>
</div>
</div>
</div>

<div id="outline-container-org7a4c683" class="outline-3">
<h3 id="org7a4c683"><span class="section-number-3">1.2</span> 客户端</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-python">import xmlrpc.client

with xmlrpc.client.ServerProxy("http://localhost:8000/") as proxy:
    print("3 is even: %s" % str(proxy.is_even(3)))
    print(proxy.kill())

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgc326ad2" class="outline-2">
<h2 id="orgc326ad2"><span class="section-number-2">2</span> Requests 与 Requests-HTML</h2>
<div class="outline-text-2" id="text-2">
<p>
官网 <a href="https://requests-html.kennethreitz.org/">https://requests-html.kennethreitz.org/</a>
</p>
</div>
<div id="outline-container-org7967cef" class="outline-3">
<h3 id="org7967cef"><span class="section-number-3">2.1</span> 安装与基本配置</h3>
<div class="outline-text-3" id="text-2-1">
<div class="org-src-container">
<pre class="src src-bash">pipenv install requests-html
</pre>
</div>
</div>
</div>
<div id="outline-container-orgaaca8df" class="outline-3">
<h3 id="orgaaca8df"><span class="section-number-3">2.2</span> 基本使用</h3>
<div class="outline-text-3" id="text-2-2">
<div class="org-src-container">
<pre class="src src-python">from requests_html import HTMLSession
session = HTMLSession()

# 抓取网页
r = session.get('https://python.org/')

# javascript 渲染
r.html.render()

# css方式搜索
about = r.html.find('#about', first=True)

# xpath方式搜索
a_xpath = r.html.xpath('a')
</pre>
</div>
</div>
</div>
<div id="outline-container-org1b858fe" class="outline-3">
<h3 id="org1b858fe"><span class="section-number-3">2.3</span> 使用 socks5 代理</h3>
<div class="outline-text-3" id="text-2-3">
<p>
首先要安装 socks 版本的 requests
</p>
<div class="org-src-container">
<pre class="src src-bash">pip install -U requests[socks]
</pre>
</div>
<p>
使用
</p>
<div class="org-src-container">
<pre class="src src-python">import requests

resp = requests.get('http://go.to', 
		    proxies=dict(http='socks5://user:pass@host:port',
				 https='socks5://user:pass@host:port'))
</pre>
</div>
</div>
</div>
<div id="outline-container-org4fe81bb" class="outline-3">
<h3 id="org4fe81bb"><span class="section-number-3">2.4</span> 下载文件</h3>
<div class="outline-text-3" id="text-2-4">
<div class="org-src-container">
<pre class="src src-python">import requests
import shutil

r = requests.get(settings.STATICMAP_URL.format(**data), stream=True)
if r.status_code == 200:
    with open(path, 'wb') as f:
	r.raw.decode_content = True
	shutil.copyfileobj(r.raw, f)    
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org39909fc" class="outline-2">
<h2 id="org39909fc"><span class="section-number-2">3</span> BeautifulSoup4</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org7eabae9" class="outline-3">
<h3 id="org7eabae9"><span class="section-number-3">3.1</span> 安装</h3>
<div class="outline-text-3" id="text-3-1">
<p>
beauiful soup4: python3-bs4
第三解析器： lxml html5lib
</p>
<div class="org-src-container">
<pre class="src src-python">from bs4 import BeautifulSoup           # 导入
soup= BeautifulSoup(html_file, 'lxml') # 初始化
soupprettify()                         # 格式化打印
</pre>
</div>
</div>
</div>
<div id="outline-container-orgbdeee6d" class="outline-3">
<h3 id="orgbdeee6d"><span class="section-number-3">3.2</span> 标签的使用</h3>
<div class="outline-text-3" id="text-3-2">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>up.title, soup.head, soup.a, soup.p</code></td>
<td class="org-left">选择tag</td>
</tr>

<tr>
<td class="org-left"><code>up.title.name, soup.title.attrs</code></td>
<td class="org-left">名字和属性</td>
</tr>

<tr>
<td class="org-left"><code>up.p['class'], soup.p.get('class')</code></td>
<td class="org-left">选择属性的方法</td>
</tr>

<tr>
<td class="org-left"><code>up.p.string</code></td>
<td class="org-left">获得内容</td>
</tr>

<tr>
<td class="org-left"><code>4.element.Comment</code></td>
<td class="org-left">注释对象</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-orgc1de9ff" class="outline-3">
<h3 id="orgc1de9ff"><span class="section-number-3">3.3</span> 标签的遍历</h3>
<div class="outline-text-3" id="text-3-3">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>up.head.contents</code></td>
<td class="org-left">获得直接子节点的列表</td>
</tr>

<tr>
<td class="org-left"><code>up.head.children</code></td>
<td class="org-left">获得可遍历的子节点对象</td>
</tr>

<tr>
<td class="org-left"><code>up.descendants</code></td>
<td class="org-left">获得全部下级节点</td>
</tr>

<tr>
<td class="org-left"><code>up.parent, soup.parents</code></td>
<td class="org-left">获得父节点</td>
</tr>

<tr>
<td class="org-left"><code>up.p.next_sibling, soup.p.previous_sibling</code></td>
<td class="org-left">获得同级节点</td>
</tr>

<tr>
<td class="org-left"><code>up.p.next_element, soup.p.previous_element</code></td>
<td class="org-left">获得下一个/上一个节点</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org9b76b29" class="outline-3">
<h3 id="org9b76b29"><span class="section-number-3">3.4</span> 标签的寻找</h3>
<div class="outline-text-3" id="text-3-4">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>up.find_all(name, attrs, recursive, text, **kwargs)</code></td>
<td class="org-left">返回list</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all('a'), soup.find_all(['a', 'b'])</code></td>
<td class="org-left">查找名字</td>
</tr>

<tr>
<td class="org-left"><code>portre;soup.find_all(re.compile("^b"))</code></td>
<td class="org-left">查找正则表达式</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all(func)</code></td>
<td class="org-left">查找一个一元函数</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all(id='aaa')</code></td>
<td class="org-left">查找属性，id，class等</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all(true, limit=2)</code></td>
<td class="org-left">限制层级数</td>
</tr>

<tr>
<td class="org-left"><code>up.find_all("title", recursive=False)</code></td>
<td class="org-left">只查找直接节点</td>
</tr>

<tr>
<td class="org-left"><code>up.find(name, attrs, recursive, text, **kwargs)</code></td>
<td class="org-left">返回对象而不是列表</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org72d93e3" class="outline-3">
<h3 id="org72d93e3"><span class="section-number-3">3.5</span> css选择器</h3>
<div class="outline-text-3" id="text-3-5">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><code>soup.select('title')</code></td>
<td class="org-left">选择名字</td>
</tr>

<tr>
<td class="org-left"><code>soup.select('.classname')</code></td>
<td class="org-left">选择类名</td>
</tr>

<tr>
<td class="org-left"><code>soup.select('#id')</code></td>
<td class="org-left">选择id</td>
</tr>

<tr>
<td class="org-left"><code>soup.select('a[class="classname"]')</code></td>
<td class="org-left">组合选择标签和属性</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="outline-container-org9b16def" class="outline-2">
<h2 id="org9b16def"><span class="section-number-2">4</span> flask</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-orgdd1bb41" class="outline-3">
<h3 id="orgdd1bb41"><span class="section-number-3">4.1</span> Flask 框架学习记录</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org1a815fe" class="outline-4">
<h4 id="org1a815fe"><span class="section-number-4">4.1.1</span> 基本使用</h4>
<div class="outline-text-4" id="text-4-1-1">
</div>
<ol class="org-ol">
<li><a id="org92d446e"></a>基本项目<br />
<div class="outline-text-5" id="text-4-1-1-1">
<p>
一个基本的文件内容如下:
</p>
<div class="org-src-container">
<pre class="src src-python"># hello.py
from flask import Flask
app = Flask(__name__)

@app.route('/')
def hello_world():
    return 'Hello, World!'from flask import Flask
</pre>
</div>
<p>
启动方式为:
</p>
<div class="org-src-container">
<pre class="src src-bash">export FLASK_APP=hello.py
flask run
</pre>
</div>
<p>
开启Debug 模式,需要额外增加环境变量: <code>export FLASK_ENV=development</code>
</p>
</div>
</li>
<li><a id="org85bb574"></a>路由规则<br />
<ol class="org-ol">
<li><a id="orge4c114f"></a>路由路径的表示<br />
<div class="outline-text-6" id="text-4-1-1-2-1">
<p>
路由使用装饰器表示,函数返回值即为网页显示内容:
</p>
<div class="org-src-container">
<pre class="src src-python"># 无匹配参数
@app.route('/')
def index():
    return 'Index Page'

# 默认匹配为字符串
@app.route('/user/&lt;username&gt;')
def show_user_profile(username):
    # show the user profile for that user
    return 'User %s' % username

# 可以指定匹配类型
@app.route('/post/&lt;int:post_id&gt;')
def show_post(post_id):
    # show the post with the given id, the id is an integer
    return 'Post %d' % post_id
</pre>
</div>
<p>
可以匹配的类型为:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">类型</th>
<th scope="col" class="org-left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>string</code></td>
<td class="org-left">字符串,这是默认值</td>
</tr>

<tr>
<td class="org-left"><code>int</code></td>
<td class="org-left">整数</td>
</tr>

<tr>
<td class="org-left"><code>float</code></td>
<td class="org-left">浮点数</td>
</tr>

<tr>
<td class="org-left"><code>path</code></td>
<td class="org-left">路径,与字符串类似,但是可以包括斜线</td>
</tr>

<tr>
<td class="org-left"><code>uuid</code></td>
<td class="org-left">uuid字符串</td>
</tr>
</tbody>
</table>
</div>
</li>
<li><a id="orga00fe46"></a>HTTP方法的表示<br />
<div class="outline-text-6" id="text-4-1-1-2-2">
<p>
可以在路由中指定可用的HTTP方法,并在函数中根据不同的方法执行不同的动作.
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import request

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
	return do_the_login()
    else:
	return show_the_login_form()
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org50898f7"></a>使用 <code>url_for</code> 生成url<br />
<ol class="org-ol">
<li><a id="orgf5e092d"></a>函数对应的url地址<br />
<div class="outline-text-6" id="text-4-1-1-3-1">
<p>
虽然可以到处硬编码url,但是不够灵活,因此应该使用 <code>url_for</code> 来生成需要的url
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import Flask, url_for

app = Flask(__name__)

@app.route('/')
def index():
    return 'index'

@app.route('/login')
def login():
    return 'login'

@app.route('/user/&lt;username&gt;')
def profile(username):
    return '{}\'s profile'.format(username)

with app.test_request_context():
    print(url_for('index'))
    print(url_for('login'))
    print(url_for('login', next='/'))
    print(url_for('profile', username='John Doe'))

# /
# /login
# /login?next=/
# /user/John%20Doe
</pre>
</div>
</div>
</li>
<li><a id="orgbce68d3"></a>静态资源的地址<br />
<div class="outline-text-6" id="text-4-1-1-3-2">
<p>
使用 <code>filename</code> 参数即可产生静态资源地址
</p>
<div class="org-src-container">
<pre class="src src-python">url_for('static', filename='style.css')
# /static/style.css
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org1ce9a3a"></a>渲染模板<br />
<div class="outline-text-5" id="text-4-1-1-4">
<p>
默认的模板引擎为 <code>Jinja2</code>, 使用函数 <code>render_template</code>, 即可从模板生成页面:
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import render_template

@app.route('/hello/')
@app.route('/hello/&lt;name&gt;')
def hello(name=None):
    return render_template('hello.html', name=name)
</pre>
</div>
<p>
所有的模板需要在 <code>templates</code> 文件夹中
一个样例模板为:
</p>
<div class="org-src-container">
<pre class="src src-html">&lt;!doctype html&gt;
&lt;title&gt;Hello from Flask&lt;/title&gt;
{% if name %}
&lt;h1&gt;Hello {{ name }}!&lt;/h1&gt;
{% else %}
&lt;h1&gt;Hello, World!&lt;/h1&gt;
{% endif %}
</pre>
</div>
</div>
</li>
<li><a id="org54509ec"></a>处理请求 <code>request</code><br />
<ol class="org-ol">
<li><a id="org4f0665f"></a>判断请求类型<br />
<div class="outline-text-6" id="text-4-1-1-5-1">
<p>
使用方法 <code>request.methods == 'POST'</code> 等
</p>
</div>
</li>
<li><a id="org24312e3"></a>获取 <code>POST</code> 与 <code>PUT</code> 中的数据<br />
<div class="outline-text-6" id="text-4-1-1-5-2">
<p>
使用 <code>request.form["key"]</code> 等
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import request
@app.route('/login', methods=['POST', 'GET'])
def login():
    error = None
    if request.method == 'POST':
	if valid_login(request.form['username'],
		       request.form['password']):
	    return log_the_user_in(request.form['username'])
	else:
	    error = 'Invalid username/password'
	    # the code below is executed if the request method
	    # was GET or the credentials were invalid
    return render_template('login.html', error=error)
</pre>
</div>
</div>
</li>
<li><a id="orgab2736c"></a>获取url中的参数<br />
<div class="outline-text-6" id="text-4-1-1-5-3">
<p>
对于形如 <code>?key=value</code> 的url, 使用 <code>args</code> 属性获取内容.
</p>
<div class="org-src-container">
<pre class="src src-python">searchword = request.args.get('key', '')
</pre>
</div>
</div>
</li>
<li><a id="org7c3e35f"></a>处理文件上传<br />
<div class="outline-text-6" id="text-4-1-1-5-4">
<p>
使用 <code>request.files</code> 方法, 以及相应的 <code>.save</code> 方法即可
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import request

@app.route('/upload', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
	f = request.files['the_file']
	f.save('/var/www/uploads/uploaded_file.txt')
	...
</pre>
</div>
<p>
为了避免一些攻击,可以使用安全文件名检查
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import request
from werkzeug.utils import secure_filename

@app.route('/upload', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
	f = request.files['the_file']
	f.save('/var/www/uploads/' + secure_filename(f.filename))
	...
</pre>
</div>
</div>
</li>
<li><a id="org3fbb0f5"></a>处理 Cookies<br />
<ol class="org-ol">
<li><a id="org3ecce46"></a>读取 Cookies<br />
<div class="outline-text-7" id="text-4-1-1-5-5-1">
<div class="org-src-container">
<pre class="src src-python">from flask import request

@app.route('/')
def index():
    username = request.cookies.get('username')
    # use cookies.get(key) instead of cookies[key] to not get a
    # KeyError if the cookie is missing.
</pre>
</div>
</div>
</li>
<li><a id="orgcf76f26"></a>设置 Cookies<br />
<div class="outline-text-7" id="text-4-1-1-5-5-2">
<div class="org-src-container">
<pre class="src src-python">from flask import make_response

@app.route('/')
def index():
    resp = make_response(render_template(...))
    resp.set_cookie('username', 'the username')
    return resp
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="org5fe8e45"></a>重定向与错误<br />
<div class="outline-text-6" id="text-4-1-1-5-6">
<p>
重定向使用 <code>redirect(url)</code> 函数.
产生错误响应使用 <code>abort(401)</code> 函数.
捕获并处理错误使用 <code>app.errorhandler(401)</code> 装饰器, 如果处理了 404 错误, 就相当于定制了 404 页面.
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import abort, redirect, url_for, render_template

@app.route('/')
def index():
    return redirect(url_for('login'))

@app.route('/login')
def login():
    abort(401)
    this_is_never_executed()

@app.errorhandler(404)
def page_not_found(error):
    return render_template('page_not_found.html'), 404
</pre>
</div>
</div>
</li>
<li><a id="orga5409c7"></a>发送响应<br />
<div class="outline-text-6" id="text-4-1-1-5-7">
<p>
在每个函数的返回值处, 返回的就是响应.
这个响应是一个三元组 <code>(响应,状态,响应头)</code>, 但这些里只有响应内容是必须要返回的, 默认的响应状态为 <code>200</code>, 而响应头会自动生成.
定制响应可以在返回值处加上状态,或使用 <code>make_response()</code> 创建一个响应,并返回它.
</p>
<div class="org-src-container">
<pre class="src src-python"># 在函数返回值处进行响应
@app.errorhandler(404)
def not_found(error):
    return render_template('error.html'), 404
# 使用 make_response 定制响应
@app.errorhandler(404)
def not_found(error):
    resp = make_response(render_template('error.html'), 404)
    resp.headers['X-Something'] = 'A value'
    return resp
</pre>
</div>
</div>
</li>
<li><a id="org455c501"></a>会话 Session<br />
<div class="outline-text-6" id="text-4-1-1-5-8">
<p>
会话是用来从一个请求向下一个请求维持数据的,需要在 Cookies 里秘密维护一个值.
因此得自己设一个密钥值,用来存在 Cookies 里, <code>app.secret_key</code>.
在登录时把它放进 Cookies 里, <code>session["..."]=request.form["..."]=</code>.
再请求时就检查一下, <code>session["..."]</code>.
退出时要清理它, <code>session.pop</code>.
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import Flask, session, redirect, url_for, escape, request

app = Flask(__name__)

# Set the secret key to some random bytes. Keep this really secret!
app.secret_key = b'_5#y2L"F4Q8z\n\xec]/'

@app.route('/')
def index():
    if 'username' in session:
	return 'Logged in as %s' % escape(session['username'])
    return 'You are not logged in'

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
	session['username'] = request.form['username']
	return redirect(url_for('index'))
    return '''
	&lt;form method="post"&gt;
	    &lt;p&gt;&lt;input type=text name=username&gt;
	    &lt;p&gt;&lt;input type=submit value=Login&gt;
	&lt;/form&gt;
    '''

@app.route('/logout')
def logout():
    # remove the username from the session if it's there
    session.pop('username', None)
    return redirect(url_for('index'))
</pre>
</div>
</div>
</li>
<li><a id="org48173e9"></a>刷新消息<br />
<div class="outline-text-6" id="text-4-1-1-5-9">
<p>
为了给用户一些反馈,需要时不时地刷新下消息,用 <code>flash</code> 方法即可.
</p>
</div>
</li>
<li><a id="org86b2150"></a>日志<br />
<div class="outline-text-6" id="text-4-1-1-5-10">
<p>
可以简单地向标准日志中写一些信息:
</p>
<div class="org-src-container">
<pre class="src src-python">app.logger.debug('A value for debugging')
app.logger.warning('A warning occurred (%d apples)', 42)
app.logger.error('An error occurred')
</pre>
</div>
</div>
</li>
<li><a id="org2f4d0f3"></a>hook WSGI 中间件<br /></li>
<li><a id="org4ef462f"></a>使用 flask 插件<br /></li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgc074e68" class="outline-4">
<h4 id="orgc074e68"><span class="section-number-4">4.1.2</span> 指南</h4>
<div class="outline-text-4" id="text-4-1-2">
</div>
<ol class="org-ol">
<li><a id="org5c122a8"></a>应用配置<br />
<ol class="org-ol">
<li><a id="orgb10eb85"></a>应用工厂函数<br />
<div class="outline-text-6" id="text-4-1-2-1-1">
<p>
虽然可以创建一个全局的APP,但更常用的方式是使用应用工厂函数.
在项目文件夹中创建 <code>__init__.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">import os

from flask import Flask


def create_app(test_config=None):
    # create and configure the app
    app = Flask(__name__, instance_relative_config=True)
    app.config.from_mapping(
	SECRET_KEY='dev',
	DATABASE=os.path.join(app.instance_path, 'flaskr.sqlite'),
    )

    if test_config is None:
	# load the instance config, if it exists, when not testing
	app.config.from_pyfile('config.py', silent=True)
    else:
	# load the test config if passed in
	app.config.from_mapping(test_config)

    # ensure the instance folder exists
    try:
	os.makedirs(app.instance_path)
    except OSError:
	pass

    # a simple page that says hello
    @app.route('/hello')
    def hello():
	return 'Hello, World!'

    return app
</pre>
</div>
</div>
</li>
<li><a id="orgb16d302"></a>运行 APP<br />
<div class="outline-text-6" id="text-4-1-2-1-2">
<div class="org-src-container">
<pre class="src src-bash">export FLASK_APP=flaskr
export FLASK_ENV=development
flask run
</pre>
</div>
</div>
</li>
<li><a id="org91ea815"></a>说明<br />
<div class="outline-text-6" id="text-4-1-2-1-3">
<ol class="org-ol">
<li><code>app = Flask(__name__, instance_relative_config=True)</code> 创建一个实例
<ol class="org-ol">
<li><code>__name__</code> 是当前项目的名称, 也就是 flask 运行是要指定的名称</li>
<li><code>instance_relative_config=True</code> 表示配置文件在实例文件夹里, 这个文件夹要在包文件的外部, 为了分离代码和数据</li>
</ol></li>
<li><code>app.config.from_mapping()</code> 设置 APP 的默认配置
<ol class="org-ol">
<li><code>SECRET_KEY</code> 在开发时设为 <code>dev</code>, 在上线是要设为一个随机值来保证安全</li>
<li><code>DATABASE</code> 是 sqlite 的位置, 在 <code>app.instance_path</code> 文件夹里</li>
</ol></li>
<li><code>app.config.from_pyfile()</code> 会重载 <code>config.py</code> 文件为了方便设置 <code>SECRET_KEY</code> 等</li>
<li>flask 不会自动创建实例文件夹, 所以用 <code>os.makedirs()</code> 来保证文件夹存在比较好</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="org1724553"></a>数据库<br />
<ol class="org-ol">
<li><a id="org50675c0"></a>连接到数据库<br />
<div class="outline-text-6" id="text-4-1-2-2-1">
<p>
创建一个 <code>db.py</code> 文件
</p>
<div class="org-src-container">
<pre class="src src-python">import sqlite3

import click
from flask import current_app, g
from flask.cli import with_appcontext


def get_db():
    if 'db' not in g:
	g.db = sqlite3.connect(
	    current_app.config['DATABASE'],
	    detect_types=sqlite3.PARSE_DECLTYPES
	)
	g.db.row_factory = sqlite3.Row

    return g.db


def close_db(e=None):
    db = g.pop('db', None)

    if db is not None:
	db.close()
</pre>
</div>
<ol class="org-ol">
<li><code>g</code> 是每个实例都不同的对象, 用来储存数据</li>
<li><code>current_app</code> 是指向处理请求的实例的对象</li>
<li><code>sqlite3.connect()</code> 建立了数据库连接</li>
<li><code>sqlite3.Row</code> 可以返回裸数据, dict 类型</li>
</ol>
</div>
</li>
<li><a id="org649c4ba"></a>建表<br />
<div class="outline-text-6" id="text-4-1-2-2-2">
<p>
新建一个 <code>schema.sql</code> 文件, 里面写 SQL 语句
</p>
<div class="org-src-container">
<pre class="src src-sql">DROP TABLE IF EXISTS user;
DROP TABLE IF EXISTS post;

CREATE TABLE user (
id INTEGER PRIMARY KEY AUTOINCREMENT,
username TEXT UNIQUE NOT NULL,
password TEXT NOT NULL
);

CREATE TABLE post (
id INTEGER PRIMARY KEY AUTOINCREMENT,
author_id INTEGER NOT NULL,
created TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
title TEXT NOT NULL,
body TEXT NOT NULL,
FOREIGN KEY (author_id) REFERENCES user (id)
);
</pre>
</div>
<p>
并在 <code>db.py</code> 里加上
</p>
<div class="org-src-container">
<pre class="src src-python">def init_db():
    db = get_db()

    with current_app.open_resource('schema.sql') as f:
	db.executescript(f.read().decode('utf8'))


@click.command('init-db')
@with_appcontext
def init_db_command():
    """Clear the existing data and create new tables."""
    init_db()
    click.echo('Initialized the database.')
</pre>
</div>
<ol class="org-ol">
<li><code>open_resource()</code> 会打开在资源文件夹里的文件</li>
<li><code>click.command()</code> 会新建一个命令行可用的命令</li>
</ol>
</div>
</li>
<li><a id="orgfefccc1"></a>注册 <code>db.py</code> 到应用<br />
<div class="outline-text-6" id="text-4-1-2-2-3">
<p>
在 <code>db.py</code> 里
</p>
<div class="org-src-container">
<pre class="src src-python">def init_app(app):
    app.teardown_appcontext(close_db)
    app.cli.add_command(init_db_command)
</pre>
</div>
<p>
在 <code>__init__.py</code> 里
</p>
<div class="org-src-container">
<pre class="src src-python">def create_app():
    app = ...
    # existing code omitted

    from . import db
    db.init_app(app)

    return app
</pre>
</div>
<ol class="org-ol">
<li><code>app.teardown_appcontext()</code> 会让 flask 在返回响应后调用这个函数</li>
<li><code>app.cli.add_command()</code> 会在命令行中新增命令</li>
</ol>
</div>
</li>
</ol>
</li>
<li><a id="orga1e2aac"></a>蓝图和视图<br />
<div class="outline-text-5" id="text-4-1-2-3">
<p>
蓝图是用来组织视图和相关代码的, 之后把蓝图注册到应用中
</p>
</div>
<ol class="org-ol">
<li><a id="org3fe415f"></a>创建蓝图<br />
<div class="outline-text-6" id="text-4-1-2-3-1">
<p>
创建一个验证身份的蓝图 <code>auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">import functools

from flask import (
    Blueprint, flash, g, redirect, render_template, request, session, url_for
)
from werkzeug.security import check_password_hash, generate_password_hash

from flaskr.db import get_db

bp = Blueprint('auth', __name__, url_prefix='/auth')
</pre>
</div>
<p>
并注册到应用中 <code>__init__.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">def create_app():
    app = ...
    # existing code omitted

    from . import auth
    app.register_blueprint(auth.bp)

    return app
</pre>
</div>
<ol class="org-ol">
<li>使用 <code>Blueprint</code> 创建蓝图</li>
<li>使用 <code>app.register_blueprint</code> 注册蓝图</li>
</ol>
</div>
</li>
<li><a id="org83b0a99"></a>第一个视图: 注册<br />
<div class="outline-text-6" id="text-4-1-2-3-2">
<p>
在 <code>auth.py</code> 文件中加入
</p>
<div class="org-src-container">
<pre class="src src-python">@bp.route('/register', methods=('GET', 'POST'))
def register():
    if request.method == 'POST':
	username = request.form['username']
	password = request.form['password']
	db = get_db()
	error = None

	if not username:
	    error = 'Username is required.'
	elif not password:
	    error = 'Password is required.'
	elif db.execute(
		'SELECT id FROM user WHERE username = ?', (username,)
	).fetchone() is not None:
	    error = 'User {} is already registered.'.format(username)

	if error is None:
	    db.execute(
		'INSERT INTO user (username, password) VALUES (?, ?)',
		(username, generate_password_hash(password))
	    )
	    db.commit()
	    return redirect(url_for('auth.login'))

	flash(error)

    return render_template('auth/register.html')
</pre>
</div>
<ol class="org-ol">
<li><code>@bp.route</code> 用来注册路由到蓝图的路径</li>
<li><code>request.form</code> 是储存请求内容的字典</li>
<li><code>db.execute</code> 可以执行 SQL 语句, 用 <code>?</code> 表示输入占位, 会自动进行检查以防止一些注入攻击</li>
<li><code>generate_password_hash()</code> 可以生成密码的 hash 值, 不应该在数据库里写入密码</li>
<li><code>db.commit()</code> 向数据库中保存数据</li>
<li><code>fetchone()</code> 和 <code>fetchall()</code> 用来返回数据库的结果</li>
<li><code>redirect()</code> 会返回重定向网址</li>
<li><code>url_for</code> 用来生成和用户名相关的网址</li>
</ol>
</div>
</li>
<li><a id="org87b44a2"></a>登录页面<br />
<div class="outline-text-6" id="text-4-1-2-3-3">
<div class="org-src-container">
<pre class="src src-python">@bp.route('/login', methods=('GET', 'POST'))
def login():
    if request.method == 'POST':
	username = request.form['username']
	password = request.form['password']
	db = get_db()
	error = None
	user = db.execute(
	    'SELECT * FROM user WHERE username = ?', (username,)
	).fetchone()

	if user is None:
	    error = 'Incorrect username.'
	elif not check_password_hash(user['password'], password):
	    error = 'Incorrect password.'

	if error is None:
	    session.clear()
	    session['user_id'] = user['id']
	    return redirect(url_for('index'))

	flash(error)

    return render_template('auth/login.html')
</pre>
</div>
<ol class="org-ol">
<li><code>check_password_hash()</code> 会检查密码和数据库里的 hash 是否匹配</li>
<li><code>session</code> 会将登录信息写入到 cookies 里发给浏览器</li>
</ol>
<div class="org-src-container">
<pre class="src src-python">@bp.before_app_request
def load_logged_in_user():
    user_id = session.get('user_id')

    if user_id is None:
	g.user = None
    else:
	g.user = get_db().execute(
	    'SELECT * FROM user WHERE id = ?', (user_id,)
	).fetchone()
</pre>
</div>
<ol class="org-ol">
<li><code>bp.before_app_request()</code> 会注册一个在运行视图函数之前就执行的函数, 用来检查 session 是否已登录</li>
</ol>
</div>
</li>
<li><a id="org1ad248c"></a>登出<br />
<div class="outline-text-6" id="text-4-1-2-3-4">
<div class="org-src-container">
<pre class="src src-python">@bp.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('index'))
</pre>
</div>
</div>
</li>
<li><a id="org7932eaf"></a>在其它视图中检查登录情况<br />
<div class="outline-text-6" id="text-4-1-2-3-5">
<div class="org-src-container">
<pre class="src src-python">def login_required(view):
    @functools.wraps(view)
    def wrapped_view(**kwargs):
	if g.user is None:
	    return redirect(url_for('auth.login'))

	return view(**kwargs)

    return wrapped_view
</pre>
</div>
<p>
这个装饰器可以在其它视图中检查是否登录, 未登录就重定向到登录页面
</p>
</div>
</li>
<li><a id="org298ac5e"></a><code>url_for</code><br />
<div class="outline-text-6" id="text-4-1-2-3-6">
<p>
为了检查蓝图中的路由, 使用 <code>'auth.login'</code> 点号来表示关系,而不是斜线
</p>
</div>
</li>
</ol>
</li>
<li><a id="org8659b89"></a>模板<br />
<div class="outline-text-5" id="text-4-1-2-4">
<div class="org-src-container">
<pre class="src src-web">&lt;!doctype html&gt;
&lt;title&gt;{% block title %}{% endblock %} - Flaskr&lt;/title&gt;
&lt;link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"&gt;
&lt;nav&gt;
    &lt;h1&gt;Flaskr&lt;/h1&gt;
    &lt;ul&gt;
	{% if g.user %}
	&lt;li&gt;&lt;span&gt;{{ g.user['username'] }}&lt;/span&gt;
	    &lt;li&gt;&lt;a href="{{ url_for('auth.logout') }}"&gt;Log Out&lt;/a&gt;
		{% else %}
		&lt;li&gt;&lt;a href="{{ url_for('auth.register') }}"&gt;Register&lt;/a&gt;
		    &lt;li&gt;&lt;a href="{{ url_for('auth.login') }}"&gt;Log In&lt;/a&gt;
			{% endif %}
    &lt;/ul&gt;
&lt;/nav&gt;
&lt;section class="content"&gt;
    &lt;header&gt;
	{% block header %}{% endblock %}
    &lt;/header&gt;
    {% for message in get_flashed_messages() %}
    &lt;div class="flash"&gt;{{ message }}&lt;/div&gt;
    {% endfor %}
    {% block content %}{% endblock %}
&lt;/section&gt;
</pre>
</div>
</div>
</li>
<li><a id="org807dda1"></a><code>setup.py</code><br />
<ol class="org-ol">
<li><a id="org5b47a56"></a>配置<br />
<div class="outline-text-6" id="text-4-1-2-5-1">
<p>
<code>setup.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">from setuptools import find_packages, setup

setup(
    name='flaskr',
    version='1.0.0',
    packages=find_packages(),
    include_package_data=True,
    zip_safe=False,
    install_requires=[
	'flask',
    ],
)
</pre>
</div>
<p>
<code>MANIFEST.in</code> 里的文件都会复制进去
</p>
<pre class="example">
include flaskr/schema.sql
graft flaskr/static
graft flaskr/templates
global-exclude *.pyc
</pre>
</div>
</li>
<li><a id="orgdb805a7"></a>安装<br />
<div class="outline-text-6" id="text-4-1-2-5-2">
<p>
<code>pip install -e .</code>
</p>
</div>
</li>
</ol>
</li>
<li><a id="orgeb6f76f"></a>测试<br />
<ol class="org-ol">
<li><a id="org3c1e50a"></a>安装<br />
<div class="outline-text-6" id="text-4-1-2-6-1">
<div class="org-src-container">
<pre class="src src-bash">pip install pytest coverage
</pre>
</div>
</div>
</li>
<li><a id="org31f2213"></a>配置<br />
<div class="outline-text-6" id="text-4-1-2-6-2">
<p>
<code>tests/data.sql</code> 临时数据库
</p>
<div class="org-src-container">
<pre class="src src-sql">INSERT INTO user (username, password)
VALUES
('test', 'pbkdf2:sha256:50000$TCI4GzcX$0de171a4f4dac32e3364c7ddc7c14f3e2fa61f2d17574483f7ffbb431b4acb2f'),
('other', 'pbkdf2:sha256:50000$kJPKsz6N$d2d4784f1b030a9761f5ccaeeaca413f27f2ecb76d6168407af962ddce849f79');

INSERT INTO post (title, body, author_id, created)
VALUES
('test title', 'test' || x'0a' || 'body', 1, '2018-01-01 00:00:00');
</pre>
</div>
<p>
<code>tests/conftest.py</code> 配置文件
</p>
<div class="org-src-container">
<pre class="src src-python">import os
import tempfile

import pytest
from flaskr import create_app
from flaskr.db import get_db, init_db

with open(os.path.join(os.path.dirname(__file__), 'data.sql'), 'rb') as f:
    _data_sql = f.read().decode('utf8')


@pytest.fixture
def app():
    db_fd, db_path = tempfile.mkstemp()

    app = create_app({
	'TESTING': True,
	'DATABASE': db_path,
    })

    with app.app_context():
	init_db()
	get_db().executescript(_data_sql)

    yield app

    os.close(db_fd)
    os.unlink(db_path)


@pytest.fixture
def client(app):
    return app.test_client()


@pytest.fixture
def runner(app):
    return app.test_cli_runner()
</pre>
</div>
<ol class="org-ol">
<li><code>tempfile.mkstemp()</code> 创建并打开临时文件</li>
<li><code>TESTING</code> 表示测试模式</li>
</ol>
</div>
</li>
<li><a id="orgf420fd3"></a>工厂函数<br />
<div class="outline-text-6" id="text-4-1-2-6-3">
<p>
<code>tests/test_factory.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">from flaskr import create_app


def test_config():
    assert not create_app().testing
    assert create_app({'TESTING': True}).testing


def test_hello(client):
    response = client.get('/hello')
    assert response.data == b'Hello, World!'
</pre>
</div>
</div>
</li>
<li><a id="org5411d90"></a>数据库<br />
<div class="outline-text-6" id="text-4-1-2-6-4">
<p>
<code>tests/test_db.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">import sqlite3

import pytest
from flaskr.db import get_db


def test_get_close_db(app):
    with app.app_context():
	db = get_db()
	assert db is get_db()

    with pytest.raises(sqlite3.ProgrammingError) as e:
	db.execute('SELECT 1')

    assert 'closed' in str(e)
def test_init_db_command(runner, monkeypatch):
    class Recorder(object):
	called = False

    def fake_init_db():
	Recorder.called = True

    monkeypatch.setattr('flaskr.db.init_db', fake_init_db)
    result = runner.invoke(args=['init-db'])
    assert 'Initialized' in result.output
    assert Recorder.called
</pre>
</div>
</div>
</li>
<li><a id="org9aa3d25"></a>身份验证<br />
<div class="outline-text-6" id="text-4-1-2-6-5">
<p>
<code>tests/conftest.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">class AuthActions(object):
    def __init__(self, client):
	self._client = client

    def login(self, username='test', password='test'):
	return self._client.post(
	    '/auth/login',
	    data={'username': username, 'password': password}
	)

    def logout(self):
	return self._client.get('/auth/logout')


@pytest.fixture
def auth(client):
    return AuthActions(client)
</pre>
</div>
<p>
<code>tests/test_auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">import pytest
from flask import g, session
from flaskr.db import get_db


def test_register(client, app):
    assert client.get('/auth/register').status_code == 200
    response = client.post(
	'/auth/register', data={'username': 'a', 'password': 'a'}
    )
    assert 'http://localhost/auth/login' == response.headers['Location']

    with app.app_context():
	assert get_db().execute(
	    "select * from user where username = 'a'",
	).fetchone() is not None


@pytest.mark.parametrize(('username', 'password', 'message'), (
    ('', '', b'Username is required.'),
    ('a', '', b'Password is required.'),
    ('test', 'test', b'already registered'),
))
def test_register_validate_input(client, username, password, message):
    response = client.post(
	'/auth/register',
	data={'username': username, 'password': password}
    )
    assert message in response.data
</pre>
</div>
<ol class="org-ol">
<li><code>client.get()</code> 创建并返回一个 <code>GET</code> 请求</li>
</ol>
<p>
<code>tests/test_auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">def test_login(client, auth):
    assert client.get('/auth/login').status_code == 200
    response = auth.login()
    assert response.headers['Location'] == 'http://localhost/'

    with client:
	client.get('/')
	assert session['user_id'] == 1
	assert g.user['username'] == 'test'


@pytest.mark.parametrize(('username', 'password', 'message'), (
    ('a', 'test', b'Incorrect username.'),
    ('test', 'a', b'Incorrect password.'),
))
def test_login_validate_input(auth, username, password, message):
    response = auth.login(username, password)
    assert message in response.data
</pre>
</div>
<p>
<code>tests/test_auth.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">def test_logout(client, auth):
    auth.login()

    with client:
	auth.logout()
	assert 'user_id' not in session
</pre>
</div>
</div>
</li>
<li><a id="org27eb85f"></a>运行测试<br />
<div class="outline-text-6" id="text-4-1-2-6-6">
<p>
<code>setup.cfg</code>
</p>
<div class="org-src-container">
<pre class="src src-text">[tool:pytest]
testpaths = tests

[coverage:run]
branch = True
source = flaskr
</pre>
</div>
<p>
运行测试 <code>pytest</code>
代码覆盖率 <code>coverage run -m pytest</code>
报告 <code>coverage report</code>
</p>
</div>
</li>
</ol>
</li>
<li><a id="org018d6dc"></a>发布<br />
<ol class="org-ol">
<li><a id="org037096e"></a>构建与安装<br />
<div class="outline-text-6" id="text-4-1-2-7-1">
<p>
<code>pip install wheel</code>
<code>python setup.py bdist_wheel</code>
</p>
</div>
</li>
<li><a id="org44061ff"></a>配置密钥<br />
<div class="outline-text-6" id="text-4-1-2-7-2">
<div class="org-src-container">
<pre class="src src-shell">python -c 'import os; print(os.urandom(16))'
b'_5#y2L"F4Q8z\n\xec]/'
</pre>
</div>
<p>
<code>venv/var/flaskr-instance/config.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">SECRET_KEY = b'_5#y2L"F4Q8z\n\xec]/'
</pre>
</div>
</div>
</li>
<li><a id="org6521fd9"></a>运行<br />
<div class="outline-text-6" id="text-4-1-2-7-3">
<p>
不要直接 <code>flask run</code>, 用别的 WSGI 服务器
<code>pip install waitress</code>
<code>waitress-serve --call 'flaskr:create_app'</code>
</p>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div id="outline-container-orgd5972bb" class="outline-4">
<h4 id="orgd5972bb"><span class="section-number-4">4.1.3</span> 插件</h4>
<div class="outline-text-4" id="text-4-1-3">
</div>
<ol class="org-ol">
<li><a id="orgdaaa13c"></a><a href="http://github.com/maxcountryman/flask-login/">Flask-Login</a><br /></li>
<li><a id="org8660dc1"></a><a href="http://github.com/flask-restful/flask-restful/">Flask-RESTful</a><br /></li>
<li><a id="org6ecfd90"></a><a href="http://github.com/mitsuhiko/flask-sqlalchemy/">Flask-SQLAlchemy</a><br /></li>
</ol>
</div>
</div>
<div id="outline-container-orge5fb3c3" class="outline-3">
<h3 id="orge5fb3c3"><span class="section-number-3">4.2</span> flask-restful 快速创建 RESTful api 服务器</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-orged12508" class="outline-4">
<h4 id="orged12508"><span class="section-number-4">4.2.1</span> 基本使用</h4>
<div class="outline-text-4" id="text-4-2-1">
</div>
<ol class="org-ol">
<li><a id="orgb762921"></a>完整的程序例子<br />
<div class="outline-text-5" id="text-4-2-1-1">
<ol class="org-ol">
<li>首先要导入flask 和 flask-restful 库, 并创建 flask app 和 flask-restful api 类.</li>
<li>创建资源类和需要响应的方法.</li>
<li>将资源类和请求url加入到 api 类里.</li>
<li><p>
运行主循环 <code>python api.py</code>
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import Flask
from flask_restful import Resource, Api

app = Flask(__name__)
api = Api(app)

class HelloWorld(Resource):
    def get(self):
	return {'hello': 'world'}

api.add_resource(HelloWorld, '/')

if __name__ == '__main__':
    app.run(debug=True)
</pre>
</div></li>
</ol>
</div>
</li>
<li><a id="org6b2d8b7"></a>路由<br />
<div class="outline-text-5" id="text-4-2-1-2">
<ol class="org-ol">
<li><p>
在加入资源类时, 路由规则与 flask 相同,也可以将匹配到的地址作为函数的参数
</p>
<div class="org-src-container">
<pre class="src src-python">from flask import Flask, request
from flask_restful import Resource, Api

app = Flask(__name__)
api = Api(app)

todos = {}

class TodoSimple(Resource):
    def get(self, todo_id):
	return {todo_id: todos[todo_id]}

    def put(self, todo_id):
	todos[todo_id] = request.form['data']
	return {todo_id: todos[todo_id]}

api.add_resource(TodoSimple, '/&lt;string:todo_id&gt;')

if __name__ == '__main__':
    app.run(debug=True)
</pre>
</div></li>

<li><p>
函数同样可以有多种返回值
</p>
<div class="org-src-container">
<pre class="src src-python">class Todo1(Resource):
    def get(self):
	# Default to 200 OK
	return {'task': 'Hello world'}

class Todo2(Resource):
    def get(self):
	# Set the response code to 201
	return {'task': 'Hello world'}, 201

class Todo3(Resource):
    def get(self):
	# Set the response code to 201 and return custom headers
	return {'task': 'Hello world'}, 201, {'Etag': 'some-opaque-string'}
</pre>
</div></li>

<li><p>
同一个资源可以有多个地址,还可以只匹配一部分
</p>
<div class="org-src-container">
<pre class="src src-python">api.add_resource(HelloWorld,
		 '/',
		 '/hello')
api.add_resource(Todo,
		 '/todo/&lt;int:todo_id&gt;', endpoint='todo_ep')
</pre>
</div></li>
</ol>
</div>
</li>

<li><a id="org6d6ffcd"></a>参数解析<br />
<div class="outline-text-5" id="text-4-2-1-3">
<p>
可以在解析路由时进行有效性验证
</p>
<div class="org-src-container">
<pre class="src src-python">from flask_restful import reqparse

parser = reqparse.RequestParser()
parser.add_argument('rate', type=int, help='Rate to charge for this resource')
args = parser.parse_args()
</pre>
</div>
</div>
</li>

<li><a id="orgb44e5ae"></a>数据格式<br />
<div class="outline-text-5" id="text-4-2-1-4">
<p>
发送数据结构很容易,但发送python对象就比较麻烦了.
使用 <code>fields</code> 和 <code>marshal_with</code> 可以解决发送python 对象的麻烦问题.
</p>
<div class="org-src-container">
<pre class="src src-python">from flask_restful import fields, marshal_with

resource_fields = {
    'task':   fields.String,
    'uri':    fields.Url('todo_ep')
}

class TodoDao(object):
    def __init__(self, todo_id, task):
	self.todo_id = todo_id
	self.task = task

	# This field will not be sent in the response
	self.status = 'active'

class Todo(Resource):
    @marshal_with(resource_fields)
    def get(self, **kwargs):
	return TodoDao(todo_id='my_todo', task='Remember the milk')
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgce8121b" class="outline-3">
<h3 id="orgce8121b"><span class="section-number-3">4.3</span> Flask-SQLAlchemy ORM 对象关系映射</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-orgf208ccf" class="outline-4">
<h4 id="orgf208ccf"><span class="section-number-4">4.3.1</span> 基本使用</h4>
<div class="outline-text-4" id="text-4-3-1">
</div>
<ol class="org-ol">
<li><a id="org7f5653d"></a>最小示例<br />
<div class="outline-text-5" id="text-4-3-1-1">
<div class="org-src-container">
<pre class="src src-python">from flask import Flask
from flask_sqlalchemy import SQLAlchemy

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:////tmp/test.db'
db = SQLAlchemy(app)


class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)

    def __repr__(self):
	return '&lt;User %r&gt;' % self.username
</pre>
</div>
<ol class="org-ol">
<li>导入 <code>flask_sqlalchemy</code> 之后就得到了该有的各种东西</li>
<li><code>Model</code> 类可用于描述模型</li>
</ol>
</div>
<ol class="org-ol">
<li><a id="org73f2ffd"></a>创建数据库<br />
<div class="outline-text-6" id="text-4-3-1-1-1">
<div class="org-src-container">
<pre class="src src-python">from yourapplication import db
db.create_all()
</pre>
</div>
</div>
</li>
<li><a id="org8c65080"></a>创建数据<br />
<div class="outline-text-6" id="text-4-3-1-1-2">
<div class="org-src-container">
<pre class="src src-python">from yourapplication import User
admin = User(username='admin', email='admin@example.com')
guest = User(username='guest', email='guest@example.com')
</pre>
</div>
</div>
</li>
<li><a id="org06c1663"></a>写入到数据库<br />
<div class="outline-text-6" id="text-4-3-1-1-3">
<div class="org-src-container">
<pre class="src src-python">db.session.add(admin)
db.session.add(guest)
db.session.commit()
</pre>
</div>
</div>
</li>
<li><a id="orgde53981"></a>查询数据<br />
<div class="outline-text-6" id="text-4-3-1-1-4">
<div class="org-src-container">
<pre class="src src-python">User.query.all()
#&gt; [&lt;User u'admin'&gt;, &lt;User u'guest'&gt;]
User.query.filter_by(username='admin').first()
#&gt; &lt;User u'admin'&gt;
</pre>
</div>
</div>
</li>
<li><a id="org09272a0"></a>重载构造函数<br />
<div class="outline-text-6" id="text-4-3-1-1-5">
<p>
默认已经提供了一个构造函数,可以这样重载它
</p>
<div class="org-src-container">
<pre class="src src-python">class Foo(db.Model):
    # ...
    def __init__(**kwargs):
	super(Foo, self).__init__(**kwargs)
	# do custom stuff
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orgced8509"></a>两个表之间的关系<br />
<div class="outline-text-5" id="text-4-3-1-2">
<div class="org-src-container">
<pre class="src src-python">from datetime import datetime


class Post(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    title = db.Column(db.String(80), nullable=False)
    body = db.Column(db.Text, nullable=False)
    pub_date = db.Column(db.DateTime, nullable=False,
			 default=datetime.utcnow)

    category_id = db.Column(db.Integer, db.ForeignKey('category.id'),
			    nullable=False)
    category = db.relationship('Category',
			       backref=db.backref('posts', lazy=True))

    def __repr__(self):
	return '&lt;Post %r&gt;' % self.title


class Category(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), nullable=False)

    def __repr__(self):
	return '&lt;Category %r&gt;' % self.name
</pre>
</div>
<p>
创建一些数据,会自动加入到关联的表里
</p>
<div class="org-src-container">
<pre class="src src-python">py = Category(name='Python')
Post(title='Hello Python!', body='Python is pretty cool', category=py)
p = Post(title='Snakes', body='Ssssssss')
py.posts.append(p)
db.session.add(py)
</pre>
</div>
<p>
在一次查询中加载所有
</p>
<div class="org-src-container">
<pre class="src src-python">from sqlalchemy.orm import joinedload
query = Category.query.options(joinedload('posts'))
for category in query:
    print category, category.posts
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div id="outline-container-org5a3bbcb" class="outline-2">
<h2 id="org5a3bbcb"><span class="section-number-2">5</span> scrapy</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org9c9a814" class="outline-3">
<h3 id="org9c9a814"><span class="section-number-3">5.1</span> 基本使用</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orgf8519f0" class="outline-4">
<h4 id="orgf8519f0"><span class="section-number-4">5.1.1</span> 创建项目</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
用命令, <code>scrapy startproject PROJECT_NAME</code> ,会自动创建文件目录结构
</p>
</div>
</div>
<div id="outline-container-org9085cb2" class="outline-4">
<h4 id="org9085cb2"><span class="section-number-4">5.1.2</span> 获取下一页以及构造item</h4>
<div class="outline-text-4" id="text-5-1-2">
<p>
<code>PROJECT_NAME/PROJECT_NAME/spiders/</code> 文件夹中利用 
scrapy genspider name domin~ 创建空文件模板
<code>parse</code> 函数中写分析网页的代码
用 <code>response.xpath('//div').extract()</code> 解析网址
</p>
</div>
<ol class="org-ol">
<li><a id="orga0d8508"></a>构造item的方法<br />
<div class="outline-text-5" id="text-5-1-2-1">
<div class="org-src-container">
<pre class="src src-python">yield {
    "image_urls":image_urls,
    "referer_url":response.url,
}
</pre>
</div>
<p>
用 <code>yield</code> 返回一个 <code>map</code> 就会自动作为item处理
</p>
</div>
</li>
<li><a id="org5897aa4"></a>向下一页的方法<br />
<div class="outline-text-5" id="text-5-1-2-2">
<div class="org-src-container">
<pre class="src src-python">for ni in response.xpath('//a'):
    if (ni.xpath('text()="下一页"').extract_first() == '1'
	and ni.xpath('@href') is not None):
	print(ni)
	next_page = ni.xpath('@href').extract_first()

    if next_page is not None:
	next_page = response.urljoin(next_page)
	yield scrapy.Request(next_page, callback=self.parse)
</pre>
</div>
<p>
只要 <code>yield</code> 一个 <code>scrapy.Request</code> 即可
</p>
</div>
</li>
</ol>
</div>
<div id="outline-container-org37661d7" class="outline-4">
<h4 id="org37661d7"><span class="section-number-4">5.1.3</span> 利用 <code>ImagesPipeline</code> 保存图片的方法</h4>
<div class="outline-text-4" id="text-5-1-3">
</div>
<ol class="org-ol">
<li><a id="orge527533"></a>使用默认版本的 <code>ImagesPipeline</code><br />
<div class="outline-text-5" id="text-5-1-3-1">
<ol class="org-ol">
<li>在item里返回 <code>"image_urls":["http://","..."]</code> 一系列图片地址即可</li>
<li>在设置里 <code>settings.py</code> 加上</li>
</ol>
<div class="org-src-container">
<pre class="src src-python">ITEM_PIPELINES = {'scrapy.pipelines.images.ImagesPipeline': 1}#启用内置图片下载
IMAGES_STORE = '/home/download_picture/img'#保存的位置
MEDIA_ALLOW_REDIRECTS = True
</pre>
</div>
</div>
</li>
<li><a id="orgbe069f2"></a>使用自定义版本<br />
<div class="outline-text-5" id="text-5-1-3-2">
<ol class="org-ol">
<li>item 可以随意设置</li>
<li>在 <code>settings.py`里的`ITEMPIPELINES</code> 改成</li>
</ol>
<div class="org-src-container">
<pre class="src src-python">ITEM_PIPELINES = {'MYPROJECT.pipelines.MYPROJECTImagesPipeline': 1}#使用自编图片下载
</pre>
</div>
<p>
基本的自编下载在 <code>pipelines.py</code> 里加上:
</p>
<div class="org-src-container">
<pre class="src src-python">import scrapy
from scrapy.pipelines.images import ImagesPipeline
from scrapy.exceptions import DropItem

class MYPROJECTImagesPipeline(ImagesPipeline):

    def get_media_requests(self, item, info):
	"""处理item"""
	for image_url in item['image_urls']:
	    yield scrapy.Request(image_url)

    def item_completed(self, results, item, info):
	"""完成后执行"""
	image_paths = [x['path'] for ok, x in results if ok]
	if not image_paths:
	    raise DropItem("Item contains no images")
	item['image_paths'] = image_paths
	return item

</pre>
</div>
</div>
</li>
<li><a id="org29310b0"></a>重命名图片名<br />
<div class="outline-text-5" id="text-5-1-3-3">
<p>
重载方法 <code>file_path</code>
</p>
<div class="org-src-container">
<pre class="src src-python">import re
from scrapy.pipelines.images import ImagesPipeline
from scrapy import Request

class ImagesrenamePipeline(ImagesPipeline):

    def get_media_requests(self, item, info):
	# 循环每一张图片地址下载，若传过来的不是集合则无需循环直接yield
	for image_url in item['imgurl']:
	    # meta里面的数据是从spider获取，然后通过meta传递给下面方法：file_path
	    yield Request(image_url,meta={'name':item['imgname']})

    # 重命名，若不重写这函数，图片名为哈希，就是一串乱七八糟的名字
    def file_path(self, request, response=None, info=None):

	# 提取url前面名称作为图片名。
	image_guid = request.url.split('/')[-1]
	# 接收上面meta传递过来的图片名称
	name = request.meta['name']
	# 过滤windows字符串，不经过这么一个步骤，你会发现有乱码或无法下载
	name = re.sub(r'[？\\*|“&lt;&gt;:/]', '', name)
	# 分文件夹存储的关键：{0}对应着name；{1}对应着image_guid
	filename = u'{0}/{1}'.format(name, image_guid)
	return filename
</pre>
</div>
</div>
</li>
</ol>
</div>
<div id="outline-container-orgf3fd2c6" class="outline-4">
<h4 id="orgf3fd2c6"><span class="section-number-4">5.1.4</span> 交互式试探解析网页</h4>
<div class="outline-text-4" id="text-5-1-4">
</div>
<ol class="org-ol">
<li><a id="org8b2e8f1"></a>配置<br />
<ol class="org-ol">
<li><a id="orgc255e8b"></a>使用 ipython<br />
<div class="outline-text-6" id="text-5-1-4-1-1">
<p>
在 <code>scrapy.cfg</code> 里加入
</p>
<div class="org-src-container">
<pre class="src src-python">[settings]
shell = bpython
</pre>
</div>
</div>
</li>
</ol>
</li>
<li><a id="orgdd19cdc"></a>打开 url<br />
<div class="outline-text-5" id="text-5-1-4-2">
<div class="org-src-container">
<pre class="src src-bash">scrapy shell file:///absolute/path/to/file.html
</pre>
</div>
</div>
</li>
<li><a id="orgb1f8a07"></a>获取资源<br />
<div class="outline-text-5" id="text-5-1-4-3">
<div class="org-src-container">
<pre class="src src-python">fetch("url")
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: chimez</p>
<p class="date">Created: 2020-12-19 Sat 14:08</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
